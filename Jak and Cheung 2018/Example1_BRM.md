---
title: '(Appendix A) Example 1: Testing equality of factor loadings in CFA (fixed-effects analysis)'
author: 'Suzanne Jak and Mike W.-L. Cheung'
date: 'June 13, 2019'
output:
  html_document:
    keep_md: yes
    self_contained: yes
    theme: united
    toc: yes
  pdf_document:
    toc: yes
  word_document: default
---

# Installing the metaSEM package
* R can be downloaded at http://www.r-project.org/.
* We only need to install the metaSEM-package once.

```r
install.packages("metaSEM")
```

# Read in the data and load metaSEM package

```r
library(metaSEM)

## Try to use multiple cores in the analyses
mxOption(key='Number of Threads', value=parallel::detectCores()-2)

## Load the functions to facilitate analysis
source("subgroup.functions.R")

# The data "Norton13" are available after loading the metaSEM package
# We display correlation matrices for first (nr 1) and the last (nr 28) study
# With the round()-function we limit the number of decimals to 2
round(Norton13$data[[1]], 2)
```

```
##       x1   x2   x3   x4   x5   x6   x7   x8   x9  x10  x11  x12  x13  x14
## x1  1.00 0.32 0.47 0.34 0.54 0.46 0.42 0.28 0.54 0.20 0.35 0.35 0.46 0.29
## x2  0.32 1.00 0.25 0.48 0.32 0.41 0.41 0.33 0.35 0.35 0.18 0.37 0.29 0.38
## x3  0.47 0.25 1.00 0.37 0.56 0.39 0.35 0.28 0.38 0.20 0.30 0.36 0.48 0.28
## x4  0.34 0.48 0.37 1.00 0.33 0.52 0.46 0.28 0.33 0.27 0.19 0.41 0.31 0.40
## x5  0.54 0.32 0.56 0.33 1.00 0.42 0.35 0.27 0.45 0.22 0.28 0.35 0.46 0.27
## x6  0.46 0.41 0.39 0.52 0.42 1.00 0.55 0.38 0.39 0.33 0.29 0.42 0.36 0.43
## x7  0.42 0.41 0.35 0.46 0.35 0.55 1.00 0.37 0.39 0.32 0.32 0.34 0.33 0.44
## x8  0.28 0.33 0.28 0.28 0.27 0.38 0.37 1.00 0.32 0.30 0.25 0.29 0.27 0.27
## x9  0.54 0.35 0.38 0.33 0.45 0.39 0.39 0.32 1.00 0.24 0.37 0.35 0.47 0.33
## x10 0.20 0.35 0.20 0.27 0.22 0.33 0.32 0.30 0.24 1.00 0.12 0.26 0.28 0.29
## x11 0.35 0.18 0.30 0.19 0.28 0.29 0.32 0.25 0.37 0.12 1.00 0.31 0.34 0.20
## x12 0.35 0.37 0.36 0.41 0.35 0.42 0.34 0.29 0.35 0.26 0.31 1.00 0.32 0.32
## x13 0.46 0.29 0.48 0.31 0.46 0.36 0.33 0.27 0.47 0.28 0.34 0.32 1.00 0.25
## x14 0.29 0.38 0.28 0.40 0.27 0.43 0.44 0.27 0.33 0.29 0.20 0.32 0.25 1.00
```

```r
round(Norton13$data[[28]], 2)
```

```
##       x1   x2   x3   x4   x5   x6   x7   x8   x9  x10  x11  x12  x13  x14
## x1  1.00 0.10 0.22 0.06 0.21 0.15 0.06 0.25 0.18 0.26 0.11 0.08 0.19 0.06
## x2  0.10 1.00 0.18 0.28 0.22 0.26 0.22 0.24 0.22 0.10 0.19 0.33 0.16 0.19
## x3  0.22 0.18 1.00 0.13 0.34 0.26 0.18 0.29 0.40 0.11 0.23 0.17 0.44 0.14
## x4  0.06 0.28 0.13 1.00 0.20 0.31 0.28 0.15 0.17 0.04 0.13 0.32 0.13 0.20
## x5  0.21 0.22 0.34 0.20 1.00 0.30 0.21 0.30 0.37 0.19 0.23 0.18 0.34 0.16
## x6  0.15 0.26 0.26 0.31 0.30 1.00 0.32 0.30 0.32 0.14 0.21 0.25 0.27 0.20
## x7  0.06 0.22 0.18 0.28 0.21 0.32 1.00 0.18 0.26 0.05 0.19 0.20 0.16 0.27
## x8  0.25 0.24 0.29 0.15 0.30 0.30 0.18 1.00 0.36 0.15 0.20 0.22 0.37 0.11
## x9  0.18 0.22 0.40 0.17 0.37 0.32 0.26 0.36 1.00 0.12 0.26 0.21 0.52 0.10
## x10 0.26 0.10 0.11 0.04 0.19 0.14 0.05 0.15 0.12 1.00 0.09 0.06 0.10 0.03
## x11 0.11 0.19 0.23 0.13 0.23 0.21 0.19 0.20 0.26 0.09 1.00 0.15 0.29 0.15
## x12 0.08 0.33 0.17 0.32 0.18 0.25 0.20 0.22 0.21 0.06 0.15 1.00 0.18 0.23
## x13 0.19 0.16 0.44 0.13 0.34 0.27 0.16 0.37 0.52 0.10 0.29 0.18 1.00 0.12
## x14 0.06 0.19 0.14 0.20 0.16 0.20 0.27 0.11 0.10 0.03 0.15 0.23 0.12 1.00
```

```r
# Display sample sizes
Norton13$n
```

```
##  [1]  512  195 5857  892  140  534  387 1028  357 3221  547  298  106  484
## [15]  801  177  521 1511  763  153  256  131  154  144  167  294 1474  716
```

```r
# Display population type
Norton13$population
```

```
##  [1] "cancer"            "community"         "community"        
##  [4] "cardiovascular"    "brain"             "cardiovascular"   
##  [7] "parkinsons"        "community"         "community"        
## [10] "community"         "community"         "motorneuro"       
## [13] "caregivers"        "elderlyinpatient"  "cardiovascular"   
## [16] "parkinsons"        "elderlyoutpatient" "generalpractice"  
## [19] "cancer"            "community"         "community"        
## [22] "eatingdisorder"    "flambowel"         "respiratory"      
## [25] "cardiovascular"    "brain"             "cancer"           
## [28] "hivaids"
```


# Stage 1 analysis overall 

```r
# Running Stage 1 model and getting the summary takes +- 4 minutes
# depending on the speed of the computer.
# The argument method = "FEM" indicates that we apply the fixed effects model
# For a random effects model one would use method = "REM"

Stage1.fit <- tssem1(Norton13$data, Norton13$n, method = "FEM")

# if the model did not converge (if OpenMx status is not 0 or 1), you may use the rerun() function to continue trying until convergence is reached

Stage1.fit <- rerun(Stage1.fit)
```

```
## Running TSSEM1 Correlation with 483 parameters
```

```
## 
## Beginning initial fit attempt
```

```
## Running TSSEM1 Correlation with 483 parameters
```

```
## 
##  Lowest minimum so far:  217061.950117783
```

```
## 
## Solution found
```



```
## 
##  Solution found!  Final fit=217061.95 (started at 217061.95)  (1 attempt(s): 1 valid, 0 errors)
```

```r
summary(Stage1.fit)
```

```
## 
## Call:
## tssem1FEM(Cov = Cov, n = n, cor.analysis = cor.analysis, model.name = model.name, 
##     cluster = cluster, suppressWarnings = suppressWarnings, silent = silent, 
##     run = run)
## 
## Coefficients:
##           Estimate Std.Error z value  Pr(>|z|)    
## S[1,2]   0.2872581 0.0062765  45.767 < 2.2e-16 ***
## S[1,3]   0.4779466 0.0052763  90.584 < 2.2e-16 ***
## S[1,4]   0.2942212 0.0062671  46.947 < 2.2e-16 ***
## S[1,5]   0.5479850 0.0047782 114.684 < 2.2e-16 ***
## S[1,6]   0.4037926 0.0057127  70.683 < 2.2e-16 ***
## S[1,7]   0.4197580 0.0056441  74.371 < 2.2e-16 ***
## S[1,8]   0.3493033 0.0059779  58.432 < 2.2e-16 ***
## S[1,9]   0.4205451 0.0056515  74.413 < 2.2e-16 ***
## S[1,10]  0.2320659 0.0064366  36.054 < 2.2e-16 ***
## S[1,11]  0.3312785 0.0060560  54.702 < 2.2e-16 ***
## S[1,12]  0.3032243 0.0062261  48.702 < 2.2e-16 ***
## S[1,13]  0.4922358 0.0051753  95.113 < 2.2e-16 ***
## S[1,14]  0.2351592 0.0064520  36.448 < 2.2e-16 ***
## S[2,3]   0.2440994 0.0064089  38.087 < 2.2e-16 ***
## S[2,4]   0.4158272 0.0057350  72.506 < 2.2e-16 ***
## S[2,5]   0.2981959 0.0062221  47.926 < 2.2e-16 ***
## S[2,6]   0.3813123 0.0058785  64.865 < 2.2e-16 ***
## S[2,7]   0.3392168 0.0060456  56.109 < 2.2e-16 ***
## S[2,8]   0.3576063 0.0059804  59.796 < 2.2e-16 ***
## S[2,9]   0.2485492 0.0063918  38.886 < 2.2e-16 ***
## S[2,10]  0.2520676 0.0064070  39.343 < 2.2e-16 ***
## S[2,11]  0.1805810 0.0065756  27.462 < 2.2e-16 ***
## S[2,12]  0.4699757 0.0053845  87.283 < 2.2e-16 ***
## S[2,13]  0.2614980 0.0063426  41.229 < 2.2e-16 ***
## S[2,14]  0.2785530 0.0063023  44.199 < 2.2e-16 ***
## S[3,4]   0.2764725 0.0063137  43.789 < 2.2e-16 ***
## S[3,5]   0.5248814 0.0049392 106.269 < 2.2e-16 ***
## S[3,6]   0.3560860 0.0059449  59.898 < 2.2e-16 ***
## S[3,7]   0.3567228 0.0059549  59.904 < 2.2e-16 ***
## S[3,8]   0.3014194 0.0061759  48.806 < 2.2e-16 ***
## S[3,9]   0.4580991 0.0053999  84.835 < 2.2e-16 ***
## S[3,10]  0.2146085 0.0064868  33.084 < 2.2e-16 ***
## S[3,11]  0.2943869 0.0062055  47.440 < 2.2e-16 ***
## S[3,12]  0.2740738 0.0063077  43.451 < 2.2e-16 ***
## S[3,13]  0.5433381 0.0048025 113.138 < 2.2e-16 ***
## S[3,14]  0.2170399 0.0065014  33.383 < 2.2e-16 ***
## S[4,5]   0.3155664 0.0061680  51.162 < 2.2e-16 ***
## S[4,6]   0.4508260 0.0055046  81.900 < 2.2e-16 ***
## S[4,7]   0.3614801 0.0059659  60.591 < 2.2e-16 ***
## S[4,8]   0.2523236 0.0064070  39.382 < 2.2e-16 ***
## S[4,9]   0.2711430 0.0063255  42.865 < 2.2e-16 ***
## S[4,10]  0.2551636 0.0063824  39.979 < 2.2e-16 ***
## S[4,11]  0.1817382 0.0065738  27.646 < 2.2e-16 ***
## S[4,12]  0.4619032 0.0054240  85.159 < 2.2e-16 ***
## S[4,13]  0.2823888 0.0062794  44.971 < 2.2e-16 ***
## S[4,14]  0.3097519 0.0061943  50.006 < 2.2e-16 ***
## S[5,6]   0.4349836 0.0055323  78.626 < 2.2e-16 ***
## S[5,7]   0.4135326 0.0056676  72.964 < 2.2e-16 ***
## S[5,8]   0.3386353 0.0060138  56.309 < 2.2e-16 ***
## S[5,9]   0.4234937 0.0056083  75.512 < 2.2e-16 ***
## S[5,10]  0.2506662 0.0063721  39.338 < 2.2e-16 ***
## S[5,11]  0.3342961 0.0060376  55.369 < 2.2e-16 ***
## S[5,12]  0.3211816 0.0061213  52.470 < 2.2e-16 ***
## S[5,13]  0.5018110 0.0050860  98.665 < 2.2e-16 ***
## S[5,14]  0.2498895 0.0064033  39.025 < 2.2e-16 ***
## S[6,7]   0.4032652 0.0057367  70.296 < 2.2e-16 ***
## S[6,8]   0.3307815 0.0060629  54.558 < 2.2e-16 ***
## S[6,9]   0.3069410 0.0061784  49.680 < 2.2e-16 ***
## S[6,10]  0.3026100 0.0061970  48.831 < 2.2e-16 ***
## S[6,11]  0.2224818 0.0064523  34.481 < 2.2e-16 ***
## S[6,12]  0.4250575 0.0056333  75.455 < 2.2e-16 ***
## S[6,13]  0.3589594 0.0059208  60.627 < 2.2e-16 ***
## S[6,14]  0.3125966 0.0061598  50.748 < 2.2e-16 ***
## S[7,8]   0.2848584 0.0062524  45.560 < 2.2e-16 ***
## S[7,9]   0.3491117 0.0059903  58.280 < 2.2e-16 ***
## S[7,10]  0.2237871 0.0064815  34.527 < 2.2e-16 ***
## S[7,11]  0.3230566 0.0060933  53.019 < 2.2e-16 ***
## S[7,12]  0.3575381 0.0059660  59.929 < 2.2e-16 ***
## S[7,13]  0.3611717 0.0059223  60.985 < 2.2e-16 ***
## S[7,14]  0.3399509 0.0060406  56.278 < 2.2e-16 ***
## S[8,9]   0.2698982 0.0063118  42.761 < 2.2e-16 ***
## S[8,10]  0.2618170 0.0063283  41.373 < 2.2e-16 ***
## S[8,11]  0.2301368 0.0064334  35.772 < 2.2e-16 ***
## S[8,12]  0.3233774 0.0061095  52.930 < 2.2e-16 ***
## S[8,13]  0.3349902 0.0060351  55.507 < 2.2e-16 ***
## S[8,14]  0.1940604 0.0065483  29.635 < 2.2e-16 ***
## S[9,10]  0.1819054 0.0065743  27.669 < 2.2e-16 ***
## S[9,11]  0.2796391 0.0062723  44.583 < 2.2e-16 ***
## S[9,12]  0.2776074 0.0062970  44.086 < 2.2e-16 ***
## S[9,13]  0.4987804 0.0051453  96.939 < 2.2e-16 ***
## S[9,14]  0.2169784 0.0064998  33.382 < 2.2e-16 ***
## S[10,11] 0.1685955 0.0065906  25.581 < 2.2e-16 ***
## S[10,12] 0.3266226 0.0061087  53.469 < 2.2e-16 ***
## S[10,13] 0.2231205 0.0064510  34.587 < 2.2e-16 ***
## S[10,14] 0.2072748 0.0065420  31.684 < 2.2e-16 ***
## S[11,12] 0.1883961 0.0065484  28.770 < 2.2e-16 ***
## S[11,13] 0.3692216 0.0058707  62.892 < 2.2e-16 ***
## S[11,14] 0.2115275 0.0064998  32.544 < 2.2e-16 ***
## S[12,13] 0.2850657 0.0062564  45.564 < 2.2e-16 ***
## S[12,14] 0.3319773 0.0060922  54.492 < 2.2e-16 ***
## S[13,14] 0.2455151 0.0064041  38.337 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                        Value
## Sample size                       21820.0000
## Chi-square of target model        10400.0403
## DF of target model                 2457.0000
## p value of target model               0.0000
## Chi-square of independence model  98426.0902
## DF of independence model           2548.0000
## RMSEA                                 0.0644
## RMSEA lower 95% CI                    0.0632
## RMSEA upper 95% CI                    0.0657
## SRMR                                  0.0980
## TLI                                   0.9141
## CFI                                   0.9172
## AIC                                5486.0403
## BIC                              -14146.8203
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
```

# Stage 2 analysis overall
* Specify the A-matrix with factor loadings, the S-matrix with variances and covariances, and the F-matrix in selecting observed variables. See Cheung (2015) or McArdle & McDonald (1984) for an explanation of the A, S and F matrices in the RAM formulation.


```r
varnames <- paste("x", 1:14, sep="")
factornames <- c("Dist","Anx","Dep")

# Vector to indicate whether variable is observed (1) or latent (0)
F <- create.Fmatrix(c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0), name="F", as.mxMatrix=FALSE)

dimnames(F) <- list(varnames,c(varnames,factornames))

## Display F
F
```

```
##     x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11 x12 x13 x14 Dist Anx Dep
## x1   1  0  0  0  0  0  0  0  0   0   0   0   0   0    0   0   0
## x2   0  1  0  0  0  0  0  0  0   0   0   0   0   0    0   0   0
## x3   0  0  1  0  0  0  0  0  0   0   0   0   0   0    0   0   0
## x4   0  0  0  1  0  0  0  0  0   0   0   0   0   0    0   0   0
## x5   0  0  0  0  1  0  0  0  0   0   0   0   0   0    0   0   0
## x6   0  0  0  0  0  1  0  0  0   0   0   0   0   0    0   0   0
## x7   0  0  0  0  0  0  1  0  0   0   0   0   0   0    0   0   0
## x8   0  0  0  0  0  0  0  1  0   0   0   0   0   0    0   0   0
## x9   0  0  0  0  0  0  0  0  1   0   0   0   0   0    0   0   0
## x10  0  0  0  0  0  0  0  0  0   1   0   0   0   0    0   0   0
## x11  0  0  0  0  0  0  0  0  0   0   1   0   0   0    0   0   0
## x12  0  0  0  0  0  0  0  0  0   0   0   1   0   0    0   0   0
## x13  0  0  0  0  0  0  0  0  0   0   0   0   1   0    0   0   0
## x14  0  0  0  0  0  0  0  0  0   0   0   0   0   1    0   0   0
```

```r
# matrix with factor loadings, later included in matrix A
lambda <-matrix(
		c("0.1*L1_1","0.1*L1_2","0",
		  "0.1*L2_1","0","0.1*L2_3",
		  "0.1*L3_1","0.1*L3_2","0",
		  "0.1*L4_1","0","0.1*L4_3",
		  "0.1*L5_1","0.1*L5_2","0",
		  "0.1*L6_1","0","0.1*L6_3",
		  "0.1*L7_1","0.1*L7_2","0",
		  "0.1*L8_1","0","0.1*L8_3",
		  "0.1*L9_1","0.1*L9_2","0",
		  "0.1*L10_1","0","0.1*L10_3",
		  "0.1*L11_1","0.1*L11_2","0",
		  "0.1*L12_1","0","0.1*L12_3",
		  "0.1*L13_1","0.1*L13_2","0",
		  "0.1*L14_1","0","0.1*L14_3"), 
	    	nrow=14, ncol=3, byrow = TRUE)

A <- rbind(cbind(matrix(0,ncol=14,nrow=14),lambda),
           matrix(0, nrow=3, ncol=17))

dimnames(A) <- list(c(varnames,factornames),c(varnames,factornames))

## Display A
A
```

```
##      x1  x2  x3  x4  x5  x6  x7  x8  x9  x10 x11 x12 x13 x14 Dist       
## x1   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L1_1" 
## x2   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L2_1" 
## x3   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L3_1" 
## x4   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L4_1" 
## x5   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L5_1" 
## x6   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L6_1" 
## x7   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L7_1" 
## x8   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L8_1" 
## x9   "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L9_1" 
## x10  "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L10_1"
## x11  "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L11_1"
## x12  "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L12_1"
## x13  "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L13_1"
## x14  "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0.1*L14_1"
## Dist "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0"        
## Anx  "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0"        
## Dep  "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0" "0"        
##      Anx         Dep        
## x1   "0.1*L1_2"  "0"        
## x2   "0"         "0.1*L2_3" 
## x3   "0.1*L3_2"  "0"        
## x4   "0"         "0.1*L4_3" 
## x5   "0.1*L5_2"  "0"        
## x6   "0"         "0.1*L6_3" 
## x7   "0.1*L7_2"  "0"        
## x8   "0"         "0.1*L8_3" 
## x9   "0.1*L9_2"  "0"        
## x10  "0"         "0.1*L10_3"
## x11  "0.1*L11_2" "0"        
## x12  "0"         "0.1*L12_3"
## x13  "0.1*L13_2" "0"        
## x14  "0"         "0.1*L14_3"
## Dist "0"         "0"        
## Anx  "0"         "0"        
## Dep  "0"         "0"
```

```r
## Convert to OpenMx-matrices
A <- as.mxMatrix(A)

# Matrix with residual variances
psi <- matrix(0, nrow = 14, ncol = 14)
diag(psi) <- paste("0.1*","e",1:14,sep="")

# Matrix with factor variances and covariances
phi <- matrix(c(1,0,0,
                0,1,0,
                0,0,1),
              nrow = 3, ncol = 3)

# Psi and phi are combined in matrix S
S <- bdiagMat(list(psi, phi))

dimnames(S) <- list(c(varnames,factornames),c(varnames,factornames))

## Display S
S
```

```
##      x1       x2       x3       x4       x5       x6       x7      
## x1   "0.1*e1" "0"      "0"      "0"      "0"      "0"      "0"     
## x2   "0"      "0.1*e2" "0"      "0"      "0"      "0"      "0"     
## x3   "0"      "0"      "0.1*e3" "0"      "0"      "0"      "0"     
## x4   "0"      "0"      "0"      "0.1*e4" "0"      "0"      "0"     
## x5   "0"      "0"      "0"      "0"      "0.1*e5" "0"      "0"     
## x6   "0"      "0"      "0"      "0"      "0"      "0.1*e6" "0"     
## x7   "0"      "0"      "0"      "0"      "0"      "0"      "0.1*e7"
## x8   "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## x9   "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## x10  "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## x11  "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## x12  "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## x13  "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## x14  "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## Dist "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## Anx  "0"      "0"      "0"      "0"      "0"      "0"      "0"     
## Dep  "0"      "0"      "0"      "0"      "0"      "0"      "0"     
##      x8       x9       x10       x11       x12       x13       x14      
## x1   "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## x2   "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## x3   "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## x4   "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## x5   "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## x6   "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## x7   "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## x8   "0.1*e8" "0"      "0"       "0"       "0"       "0"       "0"      
## x9   "0"      "0.1*e9" "0"       "0"       "0"       "0"       "0"      
## x10  "0"      "0"      "0.1*e10" "0"       "0"       "0"       "0"      
## x11  "0"      "0"      "0"       "0.1*e11" "0"       "0"       "0"      
## x12  "0"      "0"      "0"       "0"       "0.1*e12" "0"       "0"      
## x13  "0"      "0"      "0"       "0"       "0"       "0.1*e13" "0"      
## x14  "0"      "0"      "0"       "0"       "0"       "0"       "0.1*e14"
## Dist "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## Anx  "0"      "0"      "0"       "0"       "0"       "0"       "0"      
## Dep  "0"      "0"      "0"       "0"       "0"       "0"       "0"      
##      Dist Anx Dep
## x1   "0"  "0" "0"
## x2   "0"  "0" "0"
## x3   "0"  "0" "0"
## x4   "0"  "0" "0"
## x5   "0"  "0" "0"
## x6   "0"  "0" "0"
## x7   "0"  "0" "0"
## x8   "0"  "0" "0"
## x9   "0"  "0" "0"
## x10  "0"  "0" "0"
## x11  "0"  "0" "0"
## x12  "0"  "0" "0"
## x13  "0"  "0" "0"
## x14  "0"  "0" "0"
## Dist "1"  "0" "0"
## Anx  "0"  "1" "0"
## Dep  "0"  "0" "1"
```

```r
## Convert to OpenMx-matrices
S <- as.mxMatrix(S)
```

* Fitting the Stage 2 model on the pooled correlation matrix from the fixed effects Stage 1 analysis


```r
# Run the Stage 2 model
Stage2.fit <- tssem2(Stage1.fit, Amatrix=A, Smatrix=S, Fmatrix=F)
summary(Stage2.fit)
```

```
## 
## Call:
## wls(Cov = coef.tssem1FEM(tssem1.obj), aCov = vcov.tssem1FEM(tssem1.obj), 
##     n = sum(tssem1.obj$n), Amatrix = Amatrix, Smatrix = Smatrix, 
##     Fmatrix = Fmatrix, diag.constraints = diag.constraints, cor.analysis = tssem1.obj$cor.analysis, 
##     intervals.type = intervals.type, mx.algebras = mx.algebras, 
##     model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##         Estimate  Std.Error     lbound     ubound  z value  Pr(>|z|)    
## L1_2   0.1948798  0.0120541  0.1712542  0.2185054  16.1671 < 2.2e-16 ***
## L1_1   0.6908006  0.0052868  0.6804386  0.7011626 130.6648 < 2.2e-16 ***
## L10_3  0.2734487  0.0093800  0.2550641  0.2918332  29.1522 < 2.2e-16 ***
## L10_1  0.3680780  0.0069899  0.3543781  0.3817779  52.6588 < 2.2e-16 ***
## L11_2  0.1232943  0.0130601  0.0976970  0.1488917   9.4405 < 2.2e-16 ***
## L11_1  0.4758104  0.0066666  0.4627441  0.4888767  71.3723 < 2.2e-16 ***
## L12_3  0.5310361  0.0080703  0.5152187  0.5468535  65.8016 < 2.2e-16 ***
## L12_1  0.4961135  0.0064151  0.4835401  0.5086868  77.3353 < 2.2e-16 ***
## L13_2  0.4454138  0.0123411  0.4212257  0.4696020  36.0918 < 2.2e-16 ***
## L13_1  0.6297700  0.0074529  0.6151626  0.6443774  84.4999 < 2.2e-16 ***
## L14_3  0.2283294  0.0091546  0.2103866  0.2462722  24.9414 < 2.2e-16 ***
## L14_1  0.4297772  0.0066449  0.4167534  0.4428010  64.6777 < 2.2e-16 ***
## L2_3   0.4668291  0.0086670  0.4498421  0.4838161  53.8628 < 2.2e-16 ***
## L2_1   0.4702681  0.0066842  0.4571674  0.4833689  70.3555 < 2.2e-16 ***
## L3_2   0.4016615  0.0119404  0.3782588  0.4250643  33.6389 < 2.2e-16 ***
## L3_1   0.6102809  0.0071867  0.5961953  0.6243665  84.9184 < 2.2e-16 ***
## L4_3   0.4366540  0.0088317  0.4193442  0.4539637  49.4419 < 2.2e-16 ***
## L4_1   0.4973871  0.0065714  0.4845074  0.5102668  75.6895 < 2.2e-16 ***
## L5_2   0.2336727  0.0116625  0.2108147  0.2565307  20.0363 < 2.2e-16 ***
## L5_1   0.7054847  0.0053040  0.6950891  0.7158803 133.0107 < 2.2e-16 ***
## L6_3   0.2948006  0.0094074  0.2763625  0.3132386  31.3372 < 2.2e-16 ***
## L6_1   0.6146800  0.0060035  0.6029134  0.6264466 102.3874 < 2.2e-16 ***
## L7_2  -0.1257959  0.0188984 -0.1628360 -0.0887558  -6.6564 2.805e-11 ***
## L7_1   0.7109865  0.0061452  0.6989421  0.7230310 115.6973 < 2.2e-16 ***
## L8_3   0.2089882  0.0099394  0.1895073  0.2284690  21.0263 < 2.2e-16 ***
## L8_1   0.5036482  0.0065156  0.4908778  0.5164186  77.2983 < 2.2e-16 ***
## L9_2   0.3344303  0.0118478  0.3112090  0.3576515  28.2272 < 2.2e-16 ***
## L9_1   0.5569073  0.0071286  0.5429355  0.5708791  78.1230 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                                 Value
## Sample size                                21820.0000
## Chi-square of target model                  2103.1443
## DF of target model                            63.0000
## p value of target model                        0.0000
## Number of constraints imposed on "Smatrix"     0.0000
## DF manually adjusted                           0.0000
## Chi-square of independence model           43712.6142
## DF of independence model                      91.0000
## RMSEA                                          0.0385
## RMSEA lower 95% CI                             0.0371
## RMSEA upper 95% CI                             0.0399
## SRMR                                           0.0328
## TLI                                            0.9324
## CFI                                            0.9532
## AIC                                         1977.1443
## BIC                                         1473.7376
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
```

# Subgroup analysis
* We group the sample characteristics into patients versus non-patients. The variable is stored in `Norton13$group`.


```r
# Display the populations grouped into patients vs. non-patients
Norton13$group
```

```
##  [1] "patients"     "non-patients" "non-patients" "patients"    
##  [5] "patients"     "patients"     "patients"     "non-patients"
##  [9] "non-patients" "non-patients" "non-patients" "patients"    
## [13] "non-patients" "patients"     "patients"     "patients"    
## [17] "non-patients" "patients"     "patients"     "non-patients"
## [21] "non-patients" "patients"     "patients"     "patients"    
## [25] "patients"     "patients"     "patients"     "patients"
```

```r
# Stage 1 per subgroup
Stage1_subgroup.fit <- tssem1(Norton13$data, Norton13$n, method = "FEM", 
                              cluster = Norton13$group)

summary(Stage1_subgroup.fit)
```

```
## $`non-patients`
## 
## Call:
## tssem1FEM(Cov = data.cluster[[i]], n = n.cluster[[i]], cor.analysis = cor.analysis, 
##     model.name = model.name, suppressWarnings = suppressWarnings)
## 
## Coefficients:
##           Estimate Std.Error z value  Pr(>|z|)    
## S[1,2]   0.2220173 0.0086268  25.736 < 2.2e-16 ***
## S[1,3]   0.4407463 0.0073003  60.374 < 2.2e-16 ***
## S[1,4]   0.2100095 0.0086864  24.177 < 2.2e-16 ***
## S[1,5]   0.5165091 0.0066322  77.879 < 2.2e-16 ***
## S[1,6]   0.3505683 0.0079447  44.126 < 2.2e-16 ***
## S[1,7]   0.3777573 0.0077665  48.639 < 2.2e-16 ***
## S[1,8]   0.3296029 0.0080765  40.810 < 2.2e-16 ***
## S[1,9]   0.3586008 0.0078922  45.438 < 2.2e-16 ***
## S[1,10]  0.1694992 0.0087926  19.278 < 2.2e-16 ***
## S[1,11]  0.2997345 0.0082531  36.318 < 2.2e-16 ***
## S[1,12]  0.2099230 0.0086954  24.142 < 2.2e-16 ***
## S[1,13]  0.4677028 0.0070720  66.134 < 2.2e-16 ***
## S[1,14]  0.1637217 0.0088033  18.598 < 2.2e-16 ***
## S[2,3]   0.1743831 0.0087808  19.860 < 2.2e-16 ***
## S[2,4]   0.2933167 0.0082853  35.402 < 2.2e-16 ***
## S[2,5]   0.2281905 0.0085796  26.597 < 2.2e-16 ***
## S[2,6]   0.2897715 0.0083383  34.752 < 2.2e-16 ***
## S[2,7]   0.2736889 0.0083793  32.663 < 2.2e-16 ***
## S[2,8]   0.2953601 0.0083585  35.337 < 2.2e-16 ***
## S[2,9]   0.1869329 0.0087358  21.398 < 2.2e-16 ***
## S[2,10]  0.1736110 0.0088044  19.719 < 2.2e-16 ***
## S[2,11]  0.1375212 0.0088860  15.476 < 2.2e-16 ***
## S[2,12]  0.3709394 0.0078746  47.106 < 2.2e-16 ***
## S[2,13]  0.2117454 0.0086409  24.505 < 2.2e-16 ***
## S[2,14]  0.2034295 0.0086797  23.438 < 2.2e-16 ***
## S[3,4]   0.1858420 0.0087590  21.217 < 2.2e-16 ***
## S[3,5]   0.4688025 0.0070608  66.395 < 2.2e-16 ***
## S[3,6]   0.2900422 0.0082928  34.975 < 2.2e-16 ***
## S[3,7]   0.2995115 0.0082370  36.362 < 2.2e-16 ***
## S[3,8]   0.2773558 0.0083485  33.222 < 2.2e-16 ***
## S[3,9]   0.3976453 0.0076323  52.101 < 2.2e-16 ***
## S[3,10]  0.1652478 0.0087964  18.786 < 2.2e-16 ***
## S[3,11]  0.2654278 0.0084294  31.488 < 2.2e-16 ***
## S[3,12]  0.1919247 0.0087348  21.973 < 2.2e-16 ***
## S[3,13]  0.4970984 0.0068119  72.975 < 2.2e-16 ***
## S[3,14]  0.1386767 0.0088735  15.628 < 2.2e-16 ***
## S[4,5]   0.2237835 0.0086042  26.009 < 2.2e-16 ***
## S[4,6]   0.3453652 0.0079980  43.181 < 2.2e-16 ***
## S[4,7]   0.2687415 0.0084007  31.990 < 2.2e-16 ***
## S[4,8]   0.1722034 0.0088065  19.554 < 2.2e-16 ***
## S[4,9]   0.1898956 0.0087369  21.735 < 2.2e-16 ***
## S[4,10]  0.1924205 0.0087178  22.072 < 2.2e-16 ***
## S[4,11]  0.1359811 0.0088832  15.308 < 2.2e-16 ***
## S[4,12]  0.3626970 0.0078861  45.992 < 2.2e-16 ***
## S[4,13]  0.2135505 0.0086419  24.711 < 2.2e-16 ***
## S[4,14]  0.2243665 0.0085955  26.103 < 2.2e-16 ***
## S[5,6]   0.3716337 0.0077961  47.669 < 2.2e-16 ***
## S[5,7]   0.3606988 0.0078688  45.839 < 2.2e-16 ***
## S[5,8]   0.3153680 0.0081464  38.712 < 2.2e-16 ***
## S[5,9]   0.3548343 0.0079146  44.833 < 2.2e-16 ***
## S[5,10]  0.1908061 0.0087148  21.895 < 2.2e-16 ***
## S[5,11]  0.2955045 0.0082647  35.755 < 2.2e-16 ***
## S[5,12]  0.2436664 0.0085193  28.602 < 2.2e-16 ***
## S[5,13]  0.4646134 0.0070890  65.540 < 2.2e-16 ***
## S[5,14]  0.1758031 0.0087622  20.064 < 2.2e-16 ***
## S[6,7]   0.3218613 0.0081200  39.638 < 2.2e-16 ***
## S[6,8]   0.2909700 0.0083000  35.057 < 2.2e-16 ***
## S[6,9]   0.2426067 0.0085264  28.454 < 2.2e-16 ***
## S[6,10]  0.2365428 0.0085464  27.677 < 2.2e-16 ***
## S[6,11]  0.1867349 0.0087483  21.345 < 2.2e-16 ***
## S[6,12]  0.3214027 0.0081562  39.406 < 2.2e-16 ***
## S[6,13]  0.3132638 0.0081638  38.373 < 2.2e-16 ***
## S[6,14]  0.2375736 0.0085387  27.823 < 2.2e-16 ***
## S[7,8]   0.2494964 0.0084907  29.385 < 2.2e-16 ***
## S[7,9]   0.2901629 0.0082885  35.008 < 2.2e-16 ***
## S[7,10]  0.1685117 0.0088025  19.144 < 2.2e-16 ***
## S[7,11]  0.2961935 0.0082751  35.793 < 2.2e-16 ***
## S[7,12]  0.2816218 0.0083436  33.753 < 2.2e-16 ***
## S[7,13]  0.3276580 0.0080781  40.561 < 2.2e-16 ***
## S[7,14]  0.2722196 0.0083771  32.496 < 2.2e-16 ***
## S[8,9]   0.2311406 0.0085648  26.987 < 2.2e-16 ***
## S[8,10]  0.2266162 0.0085912  26.378 < 2.2e-16 ***
## S[8,11]  0.2069342 0.0086862  23.823 < 2.2e-16 ***
## S[8,12]  0.2582103 0.0084847  30.433 < 2.2e-16 ***
## S[8,13]  0.3114516 0.0081700  38.121 < 2.2e-16 ***
## S[8,14]  0.1358378 0.0088796  15.298 < 2.2e-16 ***
## S[9,10]  0.1283768 0.0089026  14.420 < 2.2e-16 ***
## S[9,11]  0.2434707 0.0085216  28.571 < 2.2e-16 ***
## S[9,12]  0.2018857 0.0086894  23.233 < 2.2e-16 ***
## S[9,13]  0.4575573 0.0071821  63.708 < 2.2e-16 ***
## S[9,14]  0.1480130 0.0088515  16.722 < 2.2e-16 ***
## S[10,11] 0.1476318 0.0088553  16.672 < 2.2e-16 ***
## S[10,12] 0.2545461 0.0084797  30.018 < 2.2e-16 ***
## S[10,13] 0.1792081 0.0087539  20.472 < 2.2e-16 ***
## S[10,14] 0.1326150 0.0088918  14.914 < 2.2e-16 ***
## S[11,12] 0.1433666 0.0088713  16.161 < 2.2e-16 ***
## S[11,13] 0.3613415 0.0078956  45.765 < 2.2e-16 ***
## S[11,14] 0.1650808 0.0088023  18.754 < 2.2e-16 ***
## S[12,13] 0.2116532 0.0086465  24.478 < 2.2e-16 ***
## S[12,14] 0.2543880 0.0084742  30.019 < 2.2e-16 ***
## S[13,14] 0.1773618 0.0087591  20.249 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                       Value
## Sample size                      12241.0000
## Chi-square of target model        3254.6011
## DF of target model                 819.0000
## p value of target model              0.0000
## Chi-square of independence model 41966.5699
## DF of independence model           910.0000
## RMSEA                                0.0493
## RMSEA lower 95% CI                   0.0475
## RMSEA upper 95% CI                   0.0511
## SRMR                                 0.0623
## TLI                                  0.9341
## CFI                                  0.9407
## AIC                               1616.6011
## BIC                              -4454.2743
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
## 
## $patients
## 
## Call:
## tssem1FEM(Cov = data.cluster[[i]], n = n.cluster[[i]], cor.analysis = cor.analysis, 
##     model.name = model.name, suppressWarnings = suppressWarnings)
## 
## Coefficients:
##           Estimate Std.Error z value  Pr(>|z|)    
## S[1,2]   0.3589723 0.0090185  39.804 < 2.2e-16 ***
## S[1,3]   0.5202306 0.0075776  68.653 < 2.2e-16 ***
## S[1,4]   0.3856090 0.0088303  43.669 < 2.2e-16 ***
## S[1,5]   0.5832701 0.0068490  85.162 < 2.2e-16 ***
## S[1,6]   0.4618187 0.0081324  56.787 < 2.2e-16 ***
## S[1,7]   0.4665827 0.0081596  57.182 < 2.2e-16 ***
## S[1,8]   0.3718755 0.0088882  41.839 < 2.2e-16 ***
## S[1,9]   0.4908596 0.0079378  61.839 < 2.2e-16 ***
## S[1,10]  0.3034491 0.0093246  32.543 < 2.2e-16 ***
## S[1,11]  0.3681541 0.0088821  41.449 < 2.2e-16 ***
## S[1,12]  0.4026261 0.0086579  46.504 < 2.2e-16 ***
## S[1,13]  0.5198201 0.0075789  68.588 < 2.2e-16 ***
## S[1,14]  0.3165073 0.0093047  34.016 < 2.2e-16 ***
## S[2,3]   0.3196375 0.0092395  34.595 < 2.2e-16 ***
## S[2,4]   0.5447111 0.0073937  73.672 < 2.2e-16 ***
## S[2,5]   0.3740101 0.0088902  42.070 < 2.2e-16 ***
## S[2,6]   0.4771459 0.0080187  59.504 < 2.2e-16 ***
## S[2,7]   0.4100152 0.0086010  47.671 < 2.2e-16 ***
## S[2,8]   0.4252404 0.0084382  50.395 < 2.2e-16 ***
## S[2,9]   0.3163333 0.0092652  34.142 < 2.2e-16 ***
## S[2,10]  0.3391362 0.0091407  37.102 < 2.2e-16 ***
## S[2,11]  0.2297085 0.0097233  23.624 < 2.2e-16 ***
## S[2,12]  0.5719582 0.0070025  81.679 < 2.2e-16 ***
## S[2,13]  0.3163669 0.0092718  34.121 < 2.2e-16 ***
## S[2,14]  0.3618762 0.0089748  40.321 < 2.2e-16 ***
## S[3,4]   0.3729933 0.0088717  42.043 < 2.2e-16 ***
## S[3,5]   0.5863183 0.0067611  86.720 < 2.2e-16 ***
## S[3,6]   0.4267440 0.0084040  50.779 < 2.2e-16 ***
## S[3,7]   0.4199386 0.0085169  49.306 < 2.2e-16 ***
## S[3,8]   0.3289946 0.0091692  35.880 < 2.2e-16 ***
## S[3,9]   0.5255864 0.0074809  70.257 < 2.2e-16 ***
## S[3,10]  0.2711370 0.0095313  28.447 < 2.2e-16 ***
## S[3,11]  0.3282190 0.0091460  35.887 < 2.2e-16 ***
## S[3,12]  0.3606703 0.0089400  40.343 < 2.2e-16 ***
## S[3,13]  0.5947078 0.0066642  89.240 < 2.2e-16 ***
## S[3,14]  0.3052447 0.0093476  32.655 < 2.2e-16 ***
## S[4,5]   0.4135132 0.0085886  48.147 < 2.2e-16 ***
## S[4,6]   0.5603158 0.0071699  78.148 < 2.2e-16 ***
## S[4,7]   0.4604963 0.0081886  56.236 < 2.2e-16 ***
## S[4,8]   0.3400941 0.0091395  37.212 < 2.2e-16 ***
## S[4,9]   0.3588626 0.0089742  39.988 < 2.2e-16 ***
## S[4,10]  0.3251665 0.0092412  35.187 < 2.2e-16 ***
## S[4,11]  0.2336865 0.0097125  24.060 < 2.2e-16 ***
## S[4,12]  0.5639916 0.0071031  79.401 < 2.2e-16 ***
## S[4,13]  0.3569135 0.0090069  39.627 < 2.2e-16 ***
## S[4,14]  0.4038049 0.0086803  46.520 < 2.2e-16 ***
## S[5,6]   0.5028304 0.0077175  65.154 < 2.2e-16 ***
## S[5,7]   0.4714855 0.0080784  58.364 < 2.2e-16 ***
## S[5,8]   0.3650442 0.0089116  40.963 < 2.2e-16 ***
## S[5,9]   0.4996655 0.0077589  64.399 < 2.2e-16 ***
## S[5,10]  0.3181843 0.0092320  34.465 < 2.2e-16 ***
## S[5,11]  0.3791192 0.0087897  43.132 < 2.2e-16 ***
## S[5,12]  0.4029169 0.0086355  46.658 < 2.2e-16 ***
## S[5,13]  0.5426677 0.0072549  74.800 < 2.2e-16 ***
## S[5,14]  0.3330228 0.0091944  36.220 < 2.2e-16 ***
## S[6,7]   0.4900095 0.0078800  62.184 < 2.2e-16 ***
## S[6,8]   0.3745472 0.0088435  42.353 < 2.2e-16 ***
## S[6,9]   0.3768991 0.0088456  42.609 < 2.2e-16 ***
## S[6,10]  0.3758098 0.0088567  42.432 < 2.2e-16 ***
## S[6,11]  0.2626837 0.0095288  27.567 < 2.2e-16 ***
## S[6,12]  0.5306689 0.0074312  71.411 < 2.2e-16 ***
## S[6,13]  0.4083603 0.0085572  47.721 < 2.2e-16 ***
## S[6,14]  0.3946581 0.0087068  45.328 < 2.2e-16 ***
## S[7,8]   0.3247738 0.0092153  35.243 < 2.2e-16 ***
## S[7,9]   0.4147547 0.0085508  48.505 < 2.2e-16 ***
## S[7,10]  0.2867122 0.0094846  30.229 < 2.2e-16 ***
## S[7,11]  0.3541806 0.0089881  39.405 < 2.2e-16 ***
## S[7,12]  0.4378547 0.0083645  52.347 < 2.2e-16 ***
## S[7,13]  0.3983398 0.0086875  45.852 < 2.2e-16 ***
## S[7,14]  0.4159087 0.0085500  48.644 < 2.2e-16 ***
## S[8,9]   0.3144775 0.0092939  33.837 < 2.2e-16 ***
## S[8,10]  0.3027494 0.0093213  32.480 < 2.2e-16 ***
## S[8,11]  0.2577935 0.0095637  26.956 < 2.2e-16 ***
## S[8,12]  0.3936819 0.0086811  45.349 < 2.2e-16 ***
## S[8,13]  0.3618757 0.0089459  40.452 < 2.2e-16 ***
## S[8,14]  0.2611649 0.0095780  27.267 < 2.2e-16 ***
## S[9,10]  0.2432445 0.0096620  25.175 < 2.2e-16 ***
## S[9,11]  0.3224117 0.0092198  34.970 < 2.2e-16 ***
## S[9,12]  0.3589313 0.0089740  39.997 < 2.2e-16 ***
## S[9,13]  0.5452400 0.0072991  74.699 < 2.2e-16 ***
## S[9,14]  0.2956801 0.0094095  31.424 < 2.2e-16 ***
## S[10,11] 0.1938563 0.0098593  19.662 < 2.2e-16 ***
## S[10,12] 0.4056047 0.0086325  46.986 < 2.2e-16 ***
## S[10,13] 0.2733783 0.0094926  28.799 < 2.2e-16 ***
## S[10,14] 0.2941425 0.0094516  31.121 < 2.2e-16 ***
## S[11,12] 0.2383152 0.0096589  24.673 < 2.2e-16 ***
## S[11,13] 0.3787195 0.0087813  43.128 < 2.2e-16 ***
## S[11,14] 0.2665800 0.0095571  27.893 < 2.2e-16 ***
## S[12,13] 0.3632599 0.0089221  40.715 < 2.2e-16 ***
## S[12,14] 0.4169592 0.0085542  48.743 < 2.2e-16 ***
## S[13,14] 0.3226122 0.0092311  34.949 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                       Value
## Sample size                       9579.0000
## Chi-square of target model        5756.8400
## DF of target model                1547.0000
## p value of target model              0.0000
## Chi-square of independence model 56459.5203
## DF of independence model          1638.0000
## RMSEA                                0.0715
## RMSEA lower 95% CI                   0.0696
## RMSEA upper 95% CI                   0.0736
## SRMR                                 0.1112
## TLI                                  0.9187
## CFI                                  0.9232
## AIC                               2662.8400
## BIC                              -8425.0171
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
```

## Run the Stage 2 model without equality constraints across groups

```r
# By providing the R-object with the Stage 1 analysis (Stage1_subgroup.fit) to the tssem2()-function, 
# the factor model is fit separately to the data of each subgroup
# Running  this model takes some minutes
Stage2_free.fit <- tssem2(Stage1_subgroup.fit, Amatrix=A, Smatrix=S, Fmatrix=F)

## summary of individual models
summary(Stage2_free.fit)
```

```
## $`non-patients`
## 
## Call:
## wls(Cov = coef.tssem1FEM(tssem1.obj), aCov = vcov.tssem1FEM(tssem1.obj), 
##     n = sum(tssem1.obj$n), Amatrix = Amatrix, Smatrix = Smatrix, 
##     Fmatrix = Fmatrix, diag.constraints = diag.constraints, cor.analysis = tssem1.obj$cor.analysis, 
##     intervals.type = intervals.type, mx.algebras = mx.algebras, 
##     model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##         Estimate  Std.Error     lbound     ubound z value  Pr(>|z|)    
## L1_2   0.1715768  0.0201028  0.1321759  0.2109776  8.5350 < 2.2e-16 ***
## L1_1   0.6795593  0.0081334  0.6636181  0.6955005 83.5514 < 2.2e-16 ***
## L10_3  0.2614715  0.0131786  0.2356418  0.2873011 19.8406 < 2.2e-16 ***
## L10_1  0.3002497  0.0098313  0.2809807  0.3195187 30.5401 < 2.2e-16 ***
## L11_2  0.1476631  0.0187339  0.1109453  0.1843809  7.8821 3.109e-15 ***
## L11_1  0.4508670  0.0098073  0.4316450  0.4700889 45.9726 < 2.2e-16 ***
## L12_3  0.5364508  0.0122967  0.5123496  0.5605520 43.6254 < 2.2e-16 ***
## L12_1  0.3909861  0.0094166  0.3725299  0.4094422 41.5211 < 2.2e-16 ***
## L13_2  0.4687695  0.0181721  0.4331528  0.5043862 25.7961 < 2.2e-16 ***
## L13_1  0.6082764  0.0109896  0.5867371  0.6298157 55.3500 < 2.2e-16 ***
## L14_3  0.2205597  0.0125852  0.1958932  0.2452263 17.5253 < 2.2e-16 ***
## L14_1  0.3311552  0.0096149  0.3123103  0.3500001 34.4418 < 2.2e-16 ***
## L2_3   0.4048715  0.0128384  0.3797087  0.4300343 31.5360 < 2.2e-16 ***
## L2_1   0.3896780  0.0097035  0.3706595  0.4086964 40.1587 < 2.2e-16 ***
## L3_2   0.3755667  0.0186579  0.3389979  0.4121355 20.1291 < 2.2e-16 ***
## L3_1   0.5670467  0.0107009  0.5460734  0.5880200 52.9907 < 2.2e-16 ***
## L4_3   0.4156571  0.0127115  0.3907429  0.4405712 32.6992 < 2.2e-16 ***
## L4_1   0.3764113  0.0095589  0.3576762  0.3951464 39.3781 < 2.2e-16 ***
## L5_2   0.1925042  0.0201037  0.1531016  0.2319067  9.5756 < 2.2e-16 ***
## L5_1   0.6810944  0.0083456  0.6647374  0.6974515 81.6113 < 2.2e-16 ***
## L6_3   0.2826866  0.0131250  0.2569620  0.3084111 21.5380 < 2.2e-16 ***
## L6_1   0.5444906  0.0087228  0.5273942  0.5615870 62.4216 < 2.2e-16 ***
## L7_2  -0.0852466  0.0239354 -0.1321591 -0.0383342 -3.5615 0.0003687 ***
## L7_1   0.6505276  0.0092936  0.6323124  0.6687427 69.9972 < 2.2e-16 ***
## L8_3   0.1829404  0.0144491  0.1546207  0.2112601 12.6610 < 2.2e-16 ***
## L8_1   0.4919958  0.0091963  0.4739713  0.5100203 53.4991 < 2.2e-16 ***
## L9_2   0.3516417  0.0163455  0.3196050  0.3836783 21.5130 < 2.2e-16 ***
## L9_1   0.4870397  0.0105677  0.4663274  0.5077520 46.0877 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                                 Value
## Sample size                                12241.0000
## Chi-square of target model                  1211.1787
## DF of target model                            63.0000
## p value of target model                        0.0000
## Number of constraints imposed on "Smatrix"     0.0000
## DF manually adjusted                           0.0000
## Chi-square of independence model           18978.1769
## DF of independence model                      91.0000
## RMSEA                                          0.0386
## RMSEA lower 95% CI                             0.0367
## RMSEA upper 95% CI                             0.0405
## SRMR                                           0.0323
## TLI                                            0.9122
## CFI                                            0.9392
## AIC                                         1085.1787
## BIC                                          618.1883
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
## 
## $patients
## 
## Call:
## wls(Cov = coef.tssem1FEM(tssem1.obj), aCov = vcov.tssem1FEM(tssem1.obj), 
##     n = sum(tssem1.obj$n), Amatrix = Amatrix, Smatrix = Smatrix, 
##     Fmatrix = Fmatrix, diag.constraints = diag.constraints, cor.analysis = tssem1.obj$cor.analysis, 
##     intervals.type = intervals.type, mx.algebras = mx.algebras, 
##     model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##         Estimate  Std.Error     lbound     ubound  z value  Pr(>|z|)    
## L1_2   0.2049211  0.0160260  0.1735107  0.2363315  12.7868 < 2.2e-16 ***
## L1_1   0.7139110  0.0071899  0.6998191  0.7280029  99.2937 < 2.2e-16 ***
## L10_3  0.2727292  0.0140084  0.2452733  0.3001852  19.4690 < 2.2e-16 ***
## L10_1  0.4465285  0.0099486  0.4270296  0.4660274  44.8835 < 2.2e-16 ***
## L11_2  0.1170005  0.0180848  0.0815548  0.1524461   6.4695 9.831e-11 ***
## L11_1  0.5012134  0.0093370  0.4829132  0.5195136  53.6803 < 2.2e-16 ***
## L12_3  0.5082274  0.0115835  0.4855241  0.5309306  43.8751 < 2.2e-16 ***
## L12_1  0.5997732  0.0087215  0.5826794  0.6168669  68.7698 < 2.2e-16 ***
## L13_2  0.4418040  0.0159056  0.4106297  0.4729784  27.7767 < 2.2e-16 ***
## L13_1  0.6498010  0.0099150  0.6303681  0.6692340  65.5375 < 2.2e-16 ***
## L14_3  0.2166634  0.0139768  0.1892694  0.2440575  15.5016 < 2.2e-16 ***
## L14_1  0.5329544  0.0091092  0.5151006  0.5508082  58.5070 < 2.2e-16 ***
## L2_3   0.5222795  0.0114768  0.4997853  0.5447736  45.5074 < 2.2e-16 ***
## L2_1   0.5509854  0.0089938  0.5333579  0.5686129  61.2630 < 2.2e-16 ***
## L3_2   0.4224922  0.0166439  0.3898709  0.4551136  25.3843 < 2.2e-16 ***
## L3_1   0.6570696  0.0098454  0.6377730  0.6763662  66.7388 < 2.2e-16 ***
## L4_3   0.4403604  0.0128756  0.4151247  0.4655961  34.2011 < 2.2e-16 ***
## L4_1   0.6165907  0.0088177  0.5993084  0.6338731  69.9264 < 2.2e-16 ***
## L5_2   0.2610033  0.0154055  0.2308091  0.2911975  16.9422 < 2.2e-16 ***
## L5_1   0.7388273  0.0071607  0.7247926  0.7528621 103.1781 < 2.2e-16 ***
## L6_3   0.2898760  0.0141321  0.2621776  0.3175744  20.5119 < 2.2e-16 ***
## L6_1   0.6912188  0.0081335  0.6752774  0.7071602  84.9839 < 2.2e-16 ***
## L7_2  -0.1309042  0.0265120 -0.1828667 -0.0789417  -4.9376 7.911e-07 ***
## L7_1   0.7611569  0.0078909  0.7456911  0.7766227  96.4605 < 2.2e-16 ***
## L8_3   0.2431807  0.0134931  0.2167347  0.2696266  18.0226 < 2.2e-16 ***
## L8_1   0.5222026  0.0091822  0.5042058  0.5401994  56.8711 < 2.2e-16 ***
## L9_2   0.3321990  0.0167111  0.2994459  0.3649522  19.8789 < 2.2e-16 ***
## L9_1   0.6219385  0.0094743  0.6033692  0.6405077  65.6450 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                                 Value
## Sample size                                 9579.0000
## Chi-square of target model                  1037.5190
## DF of target model                            63.0000
## p value of target model                        0.0000
## Number of constraints imposed on "Smatrix"     0.0000
## DF manually adjusted                           0.0000
## Chi-square of independence model           28040.3789
## DF of independence model                      91.0000
## RMSEA                                          0.0402
## RMSEA lower 95% CI                             0.0381
## RMSEA upper 95% CI                             0.0424
## SRMR                                           0.0374
## TLI                                            0.9496
## CFI                                            0.9651
## AIC                                          911.5190
## BIC                                          459.9773
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
```


```r
## summary of combined model
subgroup.summary(Stage2_free.fit)
```

```
## # # # # # # # # # # # # # # # # # # #
##  Output for subgroup MASEM analysis 
## # # # # # # # # # # # # # # # # # # #
## 
##  Total sample size: 21820
##  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the free model:
## 
##           Statistic  Free_m1
##                  df  126.000
##          Chi-square 2248.698
##                   p    0.000
##               RMSEA    0.039
##  RMSEA lower 95% CI    0.038
##  RMSEA upper 95% CI    0.041
##                 CFI    0.955
##                 TLI    0.935
##                 AIC 2416.698
##                 BIC 3087.907
##                SRMR    0.035
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
## 
##  No constrained model provided
## 
##  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```


## Run the Stage 2 model with equality constraints across groups (per factor)
*  Set factor loadings Distress equal across groups
*  Give the factor loadings of Anxiety (odd items) and Depression (even items) different labels
*  Give all residual variances different labels


```r
# Create a vector with the item numbers for each factor
Items_Anx <- c(1,3,5,7,9,11,13)
Items_Dep <- c(2,4,6,8,10,12,14)

# we create a new matrix, A_pat1, in which the factor loadings from the Anxiety facor (in column 16 of matrix A), and of the Depression factor (in column 17 of matrix A) are different
A_pat1 <- A
A_pat1$labels[Items_Anx,16] <- paste(A$labels[Items_Anx,16],"_pat",sep="")
A_pat1$labels[Items_Dep,17] <- paste(A$labels[Items_Dep,17],"_pat",sep="")

# Give the residual variances different labels for the patient group
S_pat <- S
diag(S_pat$labels)[1:14] <- paste(diag(S$labels)[1:14],"_pat",sep="") 
```

* Create the models (set run=FALSE) and multigroup model with equal factor loadings of Distress factor

```r
# we use the new A and S matrix in the patient group
stage2_pat <- tssem2(Stage1_subgroup.fit[[1]], Amatrix=A_pat1, Smatrix=S_pat, Fmatrix=F, 
                    run=FALSE, model.name="patients")

stage2_nonpat <- tssem2(Stage1_subgroup.fit[[2]], Amatrix=A, Smatrix=S, Fmatrix=F, 
                        run=FALSE, model.name="nonpatients")

# Combine the two separate models into a multigroup model
stage2_constrained_distr <- mxModel(model="same_factor_loadings_Distr", 
                                    stage2_nonpat, stage2_pat,
                                    mxFitFunctionMultigroup(c("patients", "nonpatients")))

Stage2_constrained_distr.fit <- mxRun(stage2_constrained_distr)
```


```r
# get summary using subgroup.summary() function
subgroup.summary(Stage2_free.fit, Stage2_constrained_distr.fit)
```

```
## # # # # # # # # # # # # # # # # # # #
##  Output for subgroup MASEM analysis 
## # # # # # # # # # # # # # # # # # # #
## 
##  Total sample size: 21820
## 
##  Parameter estimates of the constrained model
## 
## [1] "Set 'print.est=TRUE' to print the parameter estimates of the constrained model"
## 
##  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the free model:
## 
##           Statistic  Free_m1
##                  df  126.000
##          Chi-square 2248.698
##                   p    0.000
##               RMSEA    0.039
##  RMSEA lower 95% CI    0.038
##  RMSEA upper 95% CI    0.041
##                 CFI    0.955
##                 TLI    0.935
##                 AIC 2416.698
##                 BIC 3087.907
##                SRMR    0.035
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the model with equality constraints:
## 
##           Statistic Constrained_m2
##                  df        140.000
##          Chi-square       3116.282
##                   p          0.000
##               RMSEA          0.044
##  RMSEA lower 95% CI          0.043
##  RMSEA upper 95% CI          0.046
##                 CFI          0.936
##                 TLI          0.917
##                 AIC       3256.282
##                 BIC       3815.622
##                SRMR          0.061
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Chi-square difference between free and constrained model:
## 
##   Statistic Diff_m1_m2
##          df     14.000
##  Chi-square    867.584
##           p      0.000
## 
##  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```


* Create the models (set run=FALSE) and multigroup model with equal factor loadings of Anxiety factor


```r
A_pat2 <- A_pat1
A_pat2$labels[1:14,15] <- paste(A$labels[1:14,15],"_pat",sep="")
A_pat2$labels[Items_Anx,16] <- A$labels[Items_Anx,16]

# Create the models, make sure to set the argument run=FALSE

stage2_pat <- tssem2(Stage1_subgroup.fit[[1]], Amatrix=A_pat2, Smatrix=S_pat, Fmatrix=F, 
                     run=FALSE, model.name="patients")

stage2_nonpat <- tssem2(Stage1_subgroup.fit[[2]], Amatrix=A, Smatrix=S, Fmatrix=F, 
                        run=FALSE, model.name="nonpatients")

stage2_constrained_anx <- mxModel(model="same_factor_loadings_Anx",
                                  stage2_nonpat, stage2_pat,
                                  mxFitFunctionMultigroup(c("patients", "nonpatients")))

Stage2_constrained_anx.fit <- mxRun(stage2_constrained_anx)
```



```r
subgroup.summary(Stage2_free.fit, Stage2_constrained_anx.fit)
```

```
## # # # # # # # # # # # # # # # # # # #
##  Output for subgroup MASEM analysis 
## # # # # # # # # # # # # # # # # # # #
## 
##  Total sample size: 21820
## 
##  Parameter estimates of the constrained model
## 
## [1] "Set 'print.est=TRUE' to print the parameter estimates of the constrained model"
## 
##  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the free model:
## 
##           Statistic  Free_m1
##                  df  126.000
##          Chi-square 2248.698
##                   p    0.000
##               RMSEA    0.039
##  RMSEA lower 95% CI    0.038
##  RMSEA upper 95% CI    0.041
##                 CFI    0.955
##                 TLI    0.935
##                 AIC 2416.698
##                 BIC 3087.907
##                SRMR    0.035
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the model with equality constraints:
## 
##           Statistic Constrained_m2
##                  df        133.000
##          Chi-square       2265.612
##                   p          0.000
##               RMSEA          0.038
##  RMSEA lower 95% CI          0.037
##  RMSEA upper 95% CI          0.040
##                 CFI          0.954
##                 TLI          0.938
##                 AIC       2419.612
##                 BIC       3034.887
##                SRMR          0.036
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Chi-square difference between free and constrained model:
## 
##   Statistic Diff_m1_m2
##          df      7.000
##  Chi-square     16.914
##           p      0.018
## 
##  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```

* Create the models (set run=FALSE) and multigroup model with equal factor loadings of Depression factor


```r
#  factor loadings Depression equal across groups
A_pat3 <- A_pat2
A_pat3$labels[Items_Anx,16] <- A_pat1$labels[Items_Anx,16]
A_pat3$labels[Items_Dep,17] <- A$labels[Items_Dep,17]

# Create the models, make sure to set the argument run=FALSE

stage2_pat <- tssem2(Stage1_subgroup.fit[[1]], Amatrix=A_pat3, Smatrix=S_pat, Fmatrix=F, 
                     run=FALSE, model.name="patients")

stage2_nonpat <- tssem2(Stage1_subgroup.fit[[2]], Amatrix=A, Smatrix=S, Fmatrix=F, 
                        run=FALSE, model.name="nonpatients")

stage2_constrained_dep <- mxModel(model="same_factor_loadings_Dep", 
                                  stage2_nonpat, stage2_pat,
                                  mxFitFunctionMultigroup(c("patients", "nonpatients")))

Stage2_constrained_dep.fit <- mxRun(stage2_constrained_dep)
```



```r
subgroup.summary(Stage2_free.fit, Stage2_constrained_dep.fit)
```

```
## # # # # # # # # # # # # # # # # # # #
##  Output for subgroup MASEM analysis 
## # # # # # # # # # # # # # # # # # # #
## 
##  Total sample size: 21820
## 
##  Parameter estimates of the constrained model
## 
## [1] "Set 'print.est=TRUE' to print the parameter estimates of the constrained model"
## 
##  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the free model:
## 
##           Statistic  Free_m1
##                  df  126.000
##          Chi-square 2248.698
##                   p    0.000
##               RMSEA    0.039
##  RMSEA lower 95% CI    0.038
##  RMSEA upper 95% CI    0.041
##                 CFI    0.955
##                 TLI    0.935
##                 AIC 2416.698
##                 BIC 3087.907
##                SRMR    0.035
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the model with equality constraints:
## 
##           Statistic Constrained_m2
##                  df        133.000
##          Chi-square       2300.146
##                   p          0.000
##               RMSEA          0.039
##  RMSEA lower 95% CI          0.037
##  RMSEA upper 95% CI          0.040
##                 CFI          0.954
##                 TLI          0.937
##                 AIC       2454.146
##                 BIC       3069.420
##                SRMR          0.037
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Chi-square difference between free and constrained model:
## 
##   Statistic Diff_m1_m2
##          df      7.000
##  Chi-square     51.448
##           p      0.000
## 
##  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```

```r
sessionInfo()
```

```
## R version 3.6.0 (2019-04-26)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Linux Mint 19.1
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/openblas/libblas.so.3
## LAPACK: /usr/lib/x86_64-linux-gnu/libopenblasp-r0.2.20.so
## 
## locale:
##  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       
##  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   
##  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          
## [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] metaSEM_1.2.2.1 OpenMx_2.13.2  
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.1      mvtnorm_1.0-10  lattice_0.20-38 digest_0.6.18  
##  [5] MASS_7.3-51.4   grid_3.6.0      stats4_3.6.0    magrittr_1.5   
##  [9] ellipse_0.4.1   evaluate_0.13   stringi_1.4.3   Matrix_1.2-17  
## [13] pbivnorm_0.6.0  rmarkdown_1.12  tools_3.6.0     stringr_1.4.0  
## [17] xfun_0.6        yaml_2.2.0      parallel_3.6.0  compiler_3.6.0 
## [21] mnormt_1.5-5    htmltools_0.3.6 lavaan_0.6-3    knitr_1.22
```

