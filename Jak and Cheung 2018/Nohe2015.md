---
title: "MASEM on Nohe et al. (2015) data"
author: "Suzanne Jak and Mike Cheung"
date: 'November 02, 2018'
output:
  html_document:
    keep_md: yes
    self_contained: yes
    theme: united
    toc: yes
  pdf_document:
    toc: no
  word_document: default
editor_options: 
  chunk_output_type: console
---



# TSSEM

## A model without any moderator

```r
library(metaSEM)
```

```
## Loading required package: OpenMx
```

```
## To take full advantage of multiple cores, use:
##   mxOption(NULL, 'Number of Threads', parallel::detectCores()) #now
##   Sys.setenv(OMP_NUM_THREADS=parallel::detectCores()) #before library(OpenMx)
```

```
## "SLSQP" is set as the default optimizer in OpenMx.
```

```
## mxOption(NULL, "Gradient algorithm") is set at "central".
```

```
## mxOption(NULL, "Optimality tolerance") is set at "6.3e-14".
```

```
## mxOption(NULL, "Gradient iterations") is set at "2".
```

```r
## Proposed model in lavaan syntax
model1 <- 'W2 ~ w2w*W1 + s2w*S1
           S2 ~ w2s*W1 + s2s*S1
           W1 ~~ w1WITHs1*S1
           W2 ~~ w2WITHs2*S2
           W1 ~~ 1*W1
           S1 ~~ 1*S1
           W2 ~~ Errw2*W2
           S2 ~~ Errs2*S2'
     
RAM1 <- lavaan2RAM(model1, obs.variables=c("W1", "S1", "W2", "S2"))
RAM1
```

```
## $A
##    W1      S1      W2  S2 
## W1 "0"     "0"     "0" "0"
## S1 "0"     "0"     "0" "0"
## W2 "0*w2w" "0*s2w" "0" "0"
## S2 "0*w2s" "0*s2s" "0" "0"
## 
## $S
##    W1           S1           W2           S2          
## W1 "1"          "0*w1WITHs1" "0"          "0"         
## S1 "0*w1WITHs1" "1"          "0"          "0"         
## W2 "0"          "0"          "0*Errw2"    "0*w2WITHs2"
## S2 "0"          "0"          "0*w2WITHs2" "0*Errs2"   
## 
## $F
##    W1 S1 W2 S2
## W1  1  0  0  0
## S1  0  1  0  0
## W2  0  0  1  0
## S2  0  0  0  1
## 
## $M
##   W1 S1 W2 S2
## 1  0  0  0  0
```

```r
## Stage 1 analysis
random1 <- tssem1(Nohe15A1$data, Nohe15A1$n, method="REM", RE.type="Diag")
summary(random1)
```

```
## 
## Call:
## meta(y = ES, v = acovR, RE.constraints = Diag(paste0(RE.startvalues, 
##     "*Tau2_", 1:no.es, "_", 1:no.es)), RE.lbound = RE.lbound, 
##     I2 = I2, model.name = model.name, suppressWarnings = TRUE, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##             Estimate Std.Error    lbound    ubound z value  Pr(>|z|)    
## Intercept1 0.3804522 0.0225616 0.3362323 0.4246720 16.8629 < 2.2e-16 ***
## Intercept2 0.6051298 0.0180362 0.5697794 0.6404802 33.5508 < 2.2e-16 ***
## Intercept3 0.3032290 0.0178803 0.2681842 0.3382738 16.9588 < 2.2e-16 ***
## Intercept4 0.3036392 0.0178408 0.2686718 0.3386065 17.0194 < 2.2e-16 ***
## Intercept5 0.6166503 0.0166427 0.5840312 0.6492694 37.0523 < 2.2e-16 ***
## Intercept6 0.3954085 0.0216645 0.3529469 0.4378701 18.2515 < 2.2e-16 ***
## Tau2_1_1   0.0134777 0.0038704 0.0058919 0.0210635  3.4823 0.0004972 ***
## Tau2_2_2   0.0087592 0.0025260 0.0038083 0.0137102  3.4676 0.0005252 ***
## Tau2_3_3   0.0071123 0.0022470 0.0027082 0.0115163  3.1652 0.0015496 ** 
## Tau2_4_4   0.0070585 0.0022121 0.0027229 0.0113941  3.1909 0.0014183 ** 
## Tau2_5_5   0.0072634 0.0021092 0.0031293 0.0113974  3.4436 0.0005740 ***
## Tau2_6_6   0.0122813 0.0034848 0.0054513 0.0191114  3.5243 0.0004246 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Q statistic on the homogeneity of effect sizes: 1466.161
## Degrees of freedom of the Q statistic: 186
## P value of the Q statistic: 0
## 
## Heterogeneity indices (based on the estimated Tau2):
##                              Estimate
## Intercept1: I2 (Q statistic)   0.8829
## Intercept2: I2 (Q statistic)   0.8973
## Intercept3: I2 (Q statistic)   0.7743
## Intercept4: I2 (Q statistic)   0.7718
## Intercept5: I2 (Q statistic)   0.8810
## Intercept6: I2 (Q statistic)   0.8748
## 
## Number of studies (or clusters): 32
## Number of observed statistics: 192
## Number of estimated parameters: 12
## Degrees of freedom: 180
## -2 log likelihood: -300.1701 
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
```

```r
## Stage 2 analysis
random2 <- tssem2(random1, Amatrix=RAM1$A, Smatrix=RAM1$S)
summary(random2)
```

```
## 
## Call:
## wls(Cov = pooledS, aCov = aCov, n = tssem1.obj$total.n, Amatrix = Amatrix, 
##     Smatrix = Smatrix, Fmatrix = Fmatrix, diag.constraints = diag.constraints, 
##     cor.analysis = cor.analysis, intervals.type = intervals.type, 
##     mx.algebras = mx.algebras, model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##          Estimate Std.Error   lbound   ubound z value  Pr(>|z|)    
## s2s      0.586124  0.020790 0.545376 0.626872 28.1926 < 2.2e-16 ***
## w2s      0.080237  0.024842 0.031547 0.128927  3.2299 0.0012385 ** 
## s2w      0.085841  0.024796 0.037242 0.134440  3.4619 0.0005364 ***
## w2w      0.572471  0.022265 0.528834 0.616109 25.7122 < 2.2e-16 ***
## w1WITHs1 0.380452  0.022562 0.336232 0.424672 16.8629 < 2.2e-16 ***
## w2WITHs2 0.168885  0.025232 0.119431 0.218338  6.6933 2.182e-11 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                            Value
## Sample size                                12906
## Chi-square of target model                     0
## DF of target model                             0
## p value of target model                        0
## Number of constraints imposed on "Smatrix"     0
## DF manually adjusted                           0
## Chi-square of independence model            3079
## DF of independence model                       6
## RMSEA                                          0
## RMSEA lower 95% CI                             0
## RMSEA upper 95% CI                             0
## SRMR                                           0
## TLI                                         -Inf
## CFI                                            1
## AIC                                            0
## BIC                                            0
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
```

```r
## Plot the model
plot(random2, col="green")
```

![](Nohe2015_files/figure-html/unnamed-chunk-1-1.png)<!-- -->

## Models with three subgroup analysis

```r
## Get the necessary functions
source("http://www.suzannejak.nl/subgroup.functions.R")

data <- Nohe15A1$data
n <- Nohe15A1$n
Lag <- Nohe15A1$Lag

# Data for studies with short Lag 
data_g1 <- data[Lag<7]
n_g1 <- n[Lag<7]

# Data for studies with medium Lag 
data_g2 <- data[Lag>=7&Lag<13]
n_g2 <- n[Lag>=7&Lag<13]

# Data for studies with long Lag 
data_g3 <- data[Lag>=13]
n_g3 <- n[Lag>=13]
```

### Fitting a random-effects Stage 1 model in three subgroups

```r
## Stage 1 analysis per subgroup (random-effects analysis)
stage1_g1.fit <- tssem1(Cov = data_g1, n = n_g1, method = "REM", RE.type = "Diag")
stage1_g2.fit <- tssem1(Cov = data_g2, n = n_g2, method = "REM", RE.type = "Diag")
stage1_g3.fit <- tssem1(Cov = data_g3, n = n_g3, method = "REM", RE.type = "Diag")

## Rerun it to remove the error code
stage1_g3.fit <- rerun(stage1_g3.fit)
```



```r
## Results
summary(stage1_g1.fit)
```

```
## 
## Call:
## meta(y = ES, v = acovR, RE.constraints = Diag(paste0(RE.startvalues, 
##     "*Tau2_", 1:no.es, "_", 1:no.es)), RE.lbound = RE.lbound, 
##     I2 = I2, model.name = model.name, suppressWarnings = TRUE, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##               Estimate   Std.Error      lbound      ubound z value Pr(>|z|)    
## Intercept1  0.42860574  0.03711508  0.35586153  0.50134995 11.5480  < 2e-16 ***
## Intercept2  0.64893778  0.02491946  0.60009653  0.69777902 26.0414  < 2e-16 ***
## Intercept3  0.34725160  0.03476028  0.27912271  0.41538050  9.9899  < 2e-16 ***
## Intercept4  0.35445084  0.03474156  0.28635864  0.42254304 10.2025  < 2e-16 ***
## Intercept5  0.69211029  0.02527054  0.64258093  0.74163964 27.3880  < 2e-16 ***
## Intercept6  0.42483612  0.04413726  0.33832867  0.51134357  9.6253  < 2e-16 ***
## Tau2_1_1    0.01057582  0.00550629 -0.00021631  0.02136795  1.9207  0.05477 .  
## Tau2_2_2    0.00454042  0.00259602 -0.00054769  0.00962853  1.7490  0.08029 .  
## Tau2_3_3    0.00841151  0.00460648 -0.00061703  0.01744005  1.8260  0.06785 .  
## Tau2_4_4    0.00843306  0.00464811 -0.00067708  0.01754320  1.8143  0.06963 .  
## Tau2_5_5    0.00502725  0.00281689 -0.00049375  0.01054825  1.7847  0.07431 .  
## Tau2_6_6    0.01606560  0.00804791  0.00029199  0.03183921  1.9962  0.04591 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Q statistic on the homogeneity of effect sizes: 341.1969
## Degrees of freedom of the Q statistic: 54
## P value of the Q statistic: 0
## 
## Heterogeneity indices (based on the estimated Tau2):
##                              Estimate
## Intercept1: I2 (Q statistic)   0.8161
## Intercept2: I2 (Q statistic)   0.7993
## Intercept3: I2 (Q statistic)   0.7506
## Intercept4: I2 (Q statistic)   0.7546
## Intercept5: I2 (Q statistic)   0.8423
## Intercept6: I2 (Q statistic)   0.8662
## 
## Number of studies (or clusters): 10
## Number of observed statistics: 60
## Number of estimated parameters: 12
## Degrees of freedom: 48
## -2 log likelihood: -97.84917 
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
```

```r
summary(stage1_g2.fit)
```

```
## 
## Call:
## meta(y = ES, v = acovR, RE.constraints = Diag(paste0(RE.startvalues, 
##     "*Tau2_", 1:no.es, "_", 1:no.es)), RE.lbound = RE.lbound, 
##     I2 = I2, model.name = model.name, suppressWarnings = TRUE, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##              Estimate  Std.Error     lbound     ubound z value Pr(>|z|)    
## Intercept1 0.34829726 0.03716905 0.27544726 0.42114725  9.3706  < 2e-16 ***
## Intercept2 0.61072347 0.02048942 0.57056495 0.65088199 29.8068  < 2e-16 ***
## Intercept3 0.28588839 0.02572111 0.23547594 0.33630084 11.1149  < 2e-16 ***
## Intercept4 0.28841183 0.02673801 0.23600629 0.34081738 10.7866  < 2e-16 ***
## Intercept5 0.58850375 0.02457855 0.54033067 0.63667684 23.9438  < 2e-16 ***
## Intercept6 0.36861767 0.02911075 0.31156165 0.42567368 12.6626  < 2e-16 ***
## Tau2_1_1   0.01809558 0.00728838 0.00381062 0.03238054  2.4828  0.01304 *  
## Tau2_2_2   0.00485932 0.00231300 0.00032593 0.00939272  2.1009  0.03565 *  
## Tau2_3_3   0.00705198 0.00311184 0.00095289 0.01315106  2.2662  0.02344 *  
## Tau2_4_4   0.00784269 0.00345167 0.00107755 0.01460783  2.2721  0.02308 *  
## Tau2_5_5   0.00753170 0.00312394 0.00140890 0.01365450  2.4110  0.01591 *  
## Tau2_6_6   0.01018393 0.00414085 0.00206802 0.01829983  2.4594  0.01392 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Q statistic on the homogeneity of effect sizes: 714.1118
## Degrees of freedom of the Q statistic: 84
## P value of the Q statistic: 0
## 
## Heterogeneity indices (based on the estimated Tau2):
##                              Estimate
## Intercept1: I2 (Q statistic)   0.9053
## Intercept2: I2 (Q statistic)   0.8238
## Intercept3: I2 (Q statistic)   0.7673
## Intercept4: I2 (Q statistic)   0.7853
## Intercept5: I2 (Q statistic)   0.8730
## Intercept6: I2 (Q statistic)   0.8455
## 
## Number of studies (or clusters): 15
## Number of observed statistics: 90
## Number of estimated parameters: 12
## Degrees of freedom: 78
## -2 log likelihood: -150.9746 
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
```

```r
summary(stage1_g3.fit)
```

```
## 
## Call:
## meta(y = ES, v = acovR, RE.constraints = Diag(paste0(RE.startvalues, 
##     "*Tau2_", 1:no.es, "_", 1:no.es)), RE.lbound = RE.lbound, 
##     I2 = I2, model.name = model.name, suppressWarnings = TRUE, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##               Estimate   Std.Error      lbound      ubound z value  Pr(>|z|)    
## Intercept1  3.9659e-01  4.0654e-02  3.1691e-01  4.7627e-01  9.7554 < 2.2e-16 ***
## Intercept2  5.3658e-01  4.8887e-02  4.4076e-01  6.3239e-01 10.9758 < 2.2e-16 ***
## Intercept3  2.9657e-01  2.9445e-02  2.3885e-01  3.5428e-01 10.0719 < 2.2e-16 ***
## Intercept4  2.7917e-01  6.7672e-02  1.4654e-01  4.1181e-01  4.1254 3.701e-05 ***
## Intercept5  5.8098e-01  2.7731e-02  5.2663e-01  6.3534e-01 20.9508 < 2.2e-16 ***
## Intercept6  4.2588e-01  4.8648e-02  3.3053e-01  5.2123e-01  8.7543 < 2.2e-16 ***
## Tau2_1_1    3.2548e-03  3.4114e-03 -3.4314e-03  9.9410e-03  0.9541    0.3400    
## Tau2_2_2    1.3288e-02  8.7623e-03 -3.8855e-03  3.0462e-02  1.5165    0.1294    
## Tau2_3_3    1.1556e-03  2.7018e-03 -4.1399e-03  6.4511e-03  0.4277    0.6689    
## Tau2_4_4    1.0000e-10  4.6884e-03 -9.1890e-03  9.1890e-03  0.0000    1.0000    
## Tau2_5_5    5.5237e-04  1.7503e-03 -2.8781e-03  3.9829e-03  0.3156    0.7523    
## Tau2_6_6    8.1111e-03  5.6551e-03 -2.9728e-03  1.9195e-02  1.4343    0.1515    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Q statistic on the homogeneity of effect sizes: 254.74
## Degrees of freedom of the Q statistic: 36
## P value of the Q statistic: 0
## 
## Heterogeneity indices (based on the estimated Tau2):
##                              Estimate
## Intercept1: I2 (Q statistic)   0.6753
## Intercept2: I2 (Q statistic)   0.9303
## Intercept3: I2 (Q statistic)   0.3817
## Intercept4: I2 (Q statistic)   0.0000
## Intercept5: I2 (Q statistic)   0.3672
## Intercept6: I2 (Q statistic)   0.8458
## 
## Number of studies (or clusters): 7
## Number of observed statistics: 42
## Number of estimated parameters: 12
## Degrees of freedom: 30
## -2 log likelihood: -91.83658 
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
```

### Fitting the Stage 2 model in three subgroups

```r
## Stage 2 analysis per subgroup (random-effect analysis)
stage2_g1.fit <- tssem2(stage1_g1.fit, Amatrix=RAM1$A, Smatrix=RAM1$S)
stage2_g2.fit <- tssem2(stage1_g2.fit, Amatrix=RAM1$A, Smatrix=RAM1$S)
stage2_g3.fit <- tssem2(stage1_g3.fit, Amatrix=RAM1$A, Smatrix=RAM1$S)

## Results
summary(stage2_g1.fit)
```

```
## 
## Call:
## wls(Cov = pooledS, aCov = aCov, n = tssem1.obj$total.n, Amatrix = Amatrix, 
##     Smatrix = Smatrix, Fmatrix = Fmatrix, diag.constraints = diag.constraints, 
##     cor.analysis = cor.analysis, intervals.type = intervals.type, 
##     mx.algebras = mx.algebras, model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##             Estimate   Std.Error      lbound      ubound z value  Pr(>|z|)    
## s2s       0.66553739  0.03569842  0.59556977  0.73550502 18.6433 < 2.2e-16 ***
## w2s       0.06199845  0.04876836 -0.03358577  0.15758268  1.2713  0.203627    
## s2w       0.09348604  0.04754750  0.00029466  0.18667742  1.9662  0.049280 *  
## w2w       0.60886912  0.03478417  0.54069340  0.67704485 17.5042 < 2.2e-16 ***
## w1WITHs1  0.42860574  0.03711508  0.35586153  0.50134995 11.5480 < 2.2e-16 ***
## w2WITHs2  0.14870269  0.05135549  0.04804779  0.24935759  2.8956  0.003785 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                             Value
## Sample size                                2845.0
## Chi-square of target model                    0.0
## DF of target model                            0.0
## p value of target model                       0.0
## Number of constraints imposed on "Smatrix"    0.0
## DF manually adjusted                          0.0
## Chi-square of independence model           1561.7
## DF of independence model                      6.0
## RMSEA                                         0.0
## RMSEA lower 95% CI                            0.0
## RMSEA upper 95% CI                            0.0
## SRMR                                          0.0
## TLI                                          -Inf
## CFI                                           1.0
## AIC                                           0.0
## BIC                                           0.0
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
```

```r
summary(stage2_g2.fit)
```

```
## 
## Call:
## wls(Cov = pooledS, aCov = aCov, n = tssem1.obj$total.n, Amatrix = Amatrix, 
##     Smatrix = Smatrix, Fmatrix = Fmatrix, diag.constraints = diag.constraints, 
##     cor.analysis = cor.analysis, intervals.type = intervals.type, 
##     mx.algebras = mx.algebras, model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##          Estimate Std.Error   lbound   ubound z value  Pr(>|z|)    
## s2s      0.556431  0.029435 0.498739 0.614123 18.9036 < 2.2e-16 ***
## w2s      0.092085  0.035876 0.021770 0.162400  2.5668   0.01026 *  
## s2w      0.086149  0.036990 0.013651 0.158648  2.3290   0.01986 *  
## w2w      0.580718  0.025338 0.531056 0.630379 22.9189 < 2.2e-16 ***
## w1WITHs1 0.348297  0.037169 0.275447 0.421147  9.3706 < 2.2e-16 ***
## w2WITHs2 0.151898  0.035147 0.083011 0.220785  4.3218 1.548e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                             Value
## Sample size                                5991.0
## Chi-square of target model                    0.0
## DF of target model                            0.0
## p value of target model                       0.0
## Number of constraints imposed on "Smatrix"    0.0
## DF manually adjusted                          0.0
## Chi-square of independence model           1662.6
## DF of independence model                      6.0
## RMSEA                                         0.0
## RMSEA lower 95% CI                            0.0
## RMSEA upper 95% CI                            0.0
## SRMR                                          0.0
## TLI                                          -Inf
## CFI                                           1.0
## AIC                                           0.0
## BIC                                           0.0
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
```

```r
summary(stage2_g3.fit)
```

```
## 
## Call:
## wls(Cov = pooledS, aCov = aCov, n = tssem1.obj$total.n, Amatrix = Amatrix, 
##     Smatrix = Smatrix, Fmatrix = Fmatrix, diag.constraints = diag.constraints, 
##     cor.analysis = cor.analysis, intervals.type = intervals.type, 
##     mx.algebras = mx.algebras, model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##           Estimate Std.Error    lbound    ubound z value  Pr(>|z|)    
## s2s       0.549852  0.030200  0.490662  0.609043 18.2072 < 2.2e-16 ***
## w2s       0.078499  0.028028  0.023566  0.133433  2.8008  0.005098 ** 
## s2w       0.078761  0.061384 -0.041550  0.199073  1.2831  0.199463    
## w2w       0.505339  0.055374  0.396808  0.613871  9.1259 < 2.2e-16 ***
## w1WITHs1  0.396591  0.040654  0.316911  0.476271  9.7554 < 2.2e-16 ***
## w2WITHs2  0.230256  0.039856  0.152140  0.308372  5.7772 7.595e-09 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                             Value
## Sample size                                4070.0
## Chi-square of target model                    0.0
## DF of target model                            0.0
## p value of target model                       0.0
## Number of constraints imposed on "Smatrix"    0.0
## DF manually adjusted                          0.0
## Chi-square of independence model           1319.6
## DF of independence model                      6.0
## RMSEA                                         0.0
## RMSEA lower 95% CI                            0.0
## RMSEA upper 95% CI                            0.0
## SRMR                                          0.0
## TLI                                          -Inf
## CFI                                           1.0
## AIC                                           0.0
## BIC                                           0.0
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
```

###Testing the equality of regression coefficients
* We create and fit a model with equal direct effects (we use the same matrix A for both groups), but different variances and covariances, so we create an S matrix with different labels for group 2 and group 3.

```r
## Proposed model g2
model2 <- 'W2 ~ w2w*W1 + s2w*S1
           S2 ~ w2s*W1 + s2s*S1
           W1 ~~ g2w1WITHs1*S1
           W2 ~~ g2w2WITHs2*S2
           W1 ~~ 1*W1
           S1 ~~ 1*S1
           W2 ~~ g2Errw2*W2
           S2 ~~ g2Errs2*S2'
     
RAM2 <- lavaan2RAM(model2, obs.variables=c("W1", "S1", "W2", "S2"))

## Proposed model g3
model3 <- 'W2 ~ w2w*W1 + s2w*S1
           S2 ~ w2s*W1 + s2s*S1
           W1 ~~ g3w1WITHs1*S1
           W2 ~~ g3w2WITHs2*S2
           W1 ~~ 1*W1
           S1 ~~ 1*S1
           W2 ~~ g3Errw2*W2
           S2 ~~ g3Errs2*S2'
     
RAM3 <- lavaan2RAM(model3, obs.variables=c("W1", "S1", "W2", "S2"))

## Create the models for the two groups, make sure to set the argument run=FALSE
stage2_g1 <- tssem2(stage1_g1.fit, Amatrix=RAM1$A, Smatrix=RAM1$S, run=FALSE, model.name="g1")

stage2_g2 <- tssem2(stage1_g2.fit, Amatrix=RAM1$A, Smatrix=RAM2$S, run=FALSE, model.name="g2")

stage2_g3 <- tssem2(stage1_g3.fit, Amatrix=RAM1$A, Smatrix=RAM3$S, run=FALSE, model.name="g3")

## Create the multigroup model
stage2_constrained <- mxModel(model="same_regression_coef", stage2_g1, stage2_g2,stage2_g3,
                              mxFitFunctionMultigroup(c("g1", "g2", "g3")))

## Fit multigroup model with equality constraints
Stage2_constrained.fit <- mxRun(stage2_constrained, intervals=TRUE)
```

```
## Running same_regression_coef with 10 parameters
```

```r
## first make a list of the fitted models in the separate groups
submodels.fit <- list(stage2_g1.fit, stage2_g2.fit, stage2_g3.fit)

subgroup.summary(submodels.fit,Stage2_constrained.fit)
```

```
## # # # # # # # # # # # # # # # # # # #
##  Output for subgroup MASEM analysis 
## # # # # # # # # # # # # # # # # # # #
## 
##  Total sample size: 12906
## 
##  Parameter estimates of the constrained model
## 
## [1] "Set 'print.est=TRUE' to print the parameter estimates of the constrained model"
## 
##  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the free model:
## 
##           Statistic Free_m1
##                  df   0.000
##          Chi-square   0.000
##                   p   0.000
##               RMSEA     Inf
##  RMSEA lower 95% CI     Inf
##  RMSEA upper 95% CI     Inf
##                 CFI   1.000
##                 TLI    -Inf
##                 AIC  60.000
##                 BIC 283.963
##                SRMR   0.000
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the model with equality constraints:
## 
##           Statistic Constrained_m2
##                  df          8.000
##          Chi-square         14.739
##                   p          0.064
##               RMSEA          0.014
##  RMSEA lower 95% CI          0.000
##  RMSEA upper 95% CI          0.027
##                 CFI          0.999
##                 TLI          0.997
##                 AIC         58.739
##                 BIC        222.979
##                SRMR          0.033
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Chi-square difference between free and constrained model:
## 
##   Statistic Diff_m1_m2
##          df      8.000
##  Chi-square     14.739
##           p      0.064
## 
##  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```

### Testing the equality of one regression coefficient (w2w)
* We create and fit a model with equal direct effects (we use the same matrix A for both groups), but different variances and covariances, so we create an S matrix with different labels for group 2 and group 3.


```r
## Proposed model g2
model2 <- 'W2 ~ w2w*W1 + g2s2w*S1
           S2 ~ g2w2s*W1 + g2s2s*S1
           W1 ~~ g2w1WITHs1*S1
           W2 ~~ g2w2WITHs2*S2
           W1 ~~ 1*W1
           S1 ~~ 1*S1
           W2 ~~ g2Errw2*W2
           S2 ~~ g2Errs2*S2'
     
RAM2 <- lavaan2RAM(model2, obs.variables=c("W1", "S1", "W2", "S2"))

## Proposed model g3
model3 <- 'W2 ~ w2w*W1 + g3s2w*S1
           S2 ~ g3w2s*W1 + g3s2s*S1
           W1 ~~ g3w1WITHs1*S1
           W2 ~~ g3w2WITHs2*S2
           W1 ~~ 1*W1
           S1 ~~ 1*S1
           W2 ~~ g3Errw2*W2
           S2 ~~ g3Errs2*S2'
     
RAM3 <- lavaan2RAM(model3, obs.variables=c("W1", "S1", "W2", "S2"))

## Create the models for the two groups, make sure to set the argument run=FALSE
stage2_g1 <- tssem2(stage1_g1.fit, Amatrix=RAM1$A, Smatrix=RAM1$S, run=FALSE, model.name="g1")

stage2_g2 <- tssem2(stage1_g2.fit, Amatrix=RAM2$A, Smatrix=RAM2$S, run=FALSE, model.name="g2")

stage2_g3 <- tssem2(stage1_g3.fit, Amatrix=RAM3$A, Smatrix=RAM3$S, run=FALSE, model.name="g3")

## Create the multigroup model
stage2_constrained <- mxModel(model="same_regression_coef", stage2_g1, stage2_g2,stage2_g3,
                              mxFitFunctionMultigroup(c("g1", "g2", "g3")))

## Fit multigroup model with equality constraints
Stage2_constrained.fit <- mxRun(stage2_constrained, intervals=TRUE)
```

```
## Running same_regression_coef with 16 parameters
```

```r
## First make a list of the fitted models in the separate groups
submodels.fit <- list(stage2_g1.fit,stage2_g2.fit,stage2_g3.fit)

subgroup.summary(submodels.fit,Stage2_constrained.fit)
```

```
## # # # # # # # # # # # # # # # # # # #
##  Output for subgroup MASEM analysis 
## # # # # # # # # # # # # # # # # # # #
## 
##  Total sample size: 12906
## 
##  Parameter estimates of the constrained model
## 
## [1] "Set 'print.est=TRUE' to print the parameter estimates of the constrained model"
## 
##  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the free model:
## 
##           Statistic Free_m1
##                  df   0.000
##          Chi-square   0.000
##                   p   0.000
##               RMSEA     Inf
##  RMSEA lower 95% CI     Inf
##  RMSEA upper 95% CI     Inf
##                 CFI   1.000
##                 TLI    -Inf
##                 AIC  60.000
##                 BIC 283.963
##                SRMR   0.000
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the model with equality constraints:
## 
##           Statistic Constrained_m2
##                  df          2.000
##          Chi-square          2.527
##                   p          0.283
##               RMSEA          0.008
##  RMSEA lower 95% CI          0.000
##  RMSEA upper 95% CI          0.036
##                 CFI          1.000
##                 TLI          0.999
##                 AIC         58.527
##                 BIC        267.560
##                SRMR          0.015
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Chi-square difference between free and constrained model:
## 
##   Statistic Diff_m1_m2
##          df      2.000
##  Chi-square      2.527
##           p      0.283
## 
##  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```

## Models with two subgroup analysis

```r
# Data for studies with short Lag 
data_g1 <- data[Lag<12]
n_g1 <- n[Lag<12]

# Data for studies with long Lag 
data_g2 <- data[Lag>=12]
n_g2 <- n[Lag>=12]
```

### Fitting a random-effects Stage 1 model in two subgroups

```r
## Stage 1 analysis per subgroup (random-effects analysis)
stage1_g1.fit <- tssem1(Cov = data_g1, n = n_g1, method = "REM", RE.type = "Diag")
stage1_g2.fit <- tssem1(Cov = data_g2, n = n_g2, method = "REM", RE.type = "Diag")
## Rerun the analysis
stage1_g2.fit <- rerun(stage1_g2.fit)
```



```r
summary(stage1_g1.fit)
```

```
## 
## Call:
## meta(y = ES, v = acovR, RE.constraints = Diag(paste0(RE.startvalues, 
##     "*Tau2_", 1:no.es, "_", 1:no.es)), RE.lbound = RE.lbound, 
##     I2 = I2, model.name = model.name, suppressWarnings = TRUE, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##               Estimate   Std.Error      lbound      ubound z value Pr(>|z|)    
## Intercept1  4.6331e-01  3.4802e-02  3.9510e-01  5.3152e-01 13.3127  < 2e-16 ***
## Intercept2  6.5871e-01  1.8886e-02  6.2169e-01  6.9572e-01 34.8782  < 2e-16 ***
## Intercept3  3.6924e-01  3.0810e-02  3.0886e-01  4.2963e-01 11.9846  < 2e-16 ***
## Intercept4  3.7718e-01  3.1986e-02  3.1449e-01  4.3987e-01 11.7923  < 2e-16 ***
## Intercept5  6.7273e-01  2.7748e-02  6.1834e-01  7.2711e-01 24.2446  < 2e-16 ***
## Intercept6  4.4613e-01  3.9848e-02  3.6803e-01  5.2423e-01 11.1959  < 2e-16 ***
## Tau2_1_1    1.3297e-02  5.7560e-03  2.0154e-03  2.4578e-02  2.3101  0.02088 *  
## Tau2_2_2    3.3131e-03  1.7387e-03 -9.4593e-05  6.7208e-03  1.9056  0.05671 .  
## Tau2_3_3    9.3795e-03  4.2626e-03  1.0249e-03  1.7734e-02  2.2004  0.02778 *  
## Tau2_4_4    1.0324e-02  4.7309e-03  1.0512e-03  1.9596e-02  2.1822  0.02910 *  
## Tau2_5_5    8.7112e-03  3.8165e-03  1.2310e-03  1.6191e-02  2.2825  0.02246 *  
## Tau2_6_6    1.8025e-02  7.6104e-03  3.1090e-03  3.2941e-02  2.3685  0.01786 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Q statistic on the homogeneity of effect sizes: 734.0563
## Degrees of freedom of the Q statistic: 72
## P value of the Q statistic: 0
## 
## Heterogeneity indices (based on the estimated Tau2):
##                              Estimate
## Intercept1: I2 (Q statistic)   0.8943
## Intercept2: I2 (Q statistic)   0.7986
## Intercept3: I2 (Q statistic)   0.8257
## Intercept4: I2 (Q statistic)   0.8407
## Intercept5: I2 (Q statistic)   0.9166
## Intercept6: I2 (Q statistic)   0.9149
## 
## Number of studies (or clusters): 13
## Number of observed statistics: 78
## Number of estimated parameters: 12
## Degrees of freedom: 66
## -2 log likelihood: -122.837 
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
```

```r
summary(stage1_g2.fit)
```

```
## 
## Call:
## meta(y = ES, v = acovR, RE.constraints = Diag(paste0(RE.startvalues, 
##     "*Tau2_", 1:no.es, "_", 1:no.es)), RE.lbound = RE.lbound, 
##     I2 = I2, model.name = model.name, suppressWarnings = TRUE, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##               Estimate   Std.Error      lbound      ubound z value  Pr(>|z|)    
## Intercept1  0.32573372  0.02286302  0.28092302  0.37054442 14.2472 < 2.2e-16 ***
## Intercept2  0.57069918  0.02385056  0.52395294  0.61744542 23.9281 < 2.2e-16 ***
## Intercept3  0.26146825  0.01444457  0.23315741  0.28977908 18.1015 < 2.2e-16 ***
## Intercept4  0.25259609  0.01201123  0.22905452  0.27613766 21.0300 < 2.2e-16 ***
## Intercept5  0.57722168  0.01668253  0.54452451  0.60991885 34.6004 < 2.2e-16 ***
## Intercept6  0.36349456  0.02093828  0.32245628  0.40453284 17.3603 < 2.2e-16 ***
## Tau2_1_1    0.00721522  0.00304222  0.00125258  0.01317786  2.3717  0.017707 *  
## Tau2_2_2    0.00903673  0.00346802  0.00223953  0.01583392  2.6057  0.009168 ** 
## Tau2_3_3    0.00125765  0.00110733 -0.00091267  0.00342797  1.1358  0.256059    
## Tau2_4_4    0.00032457  0.00050817 -0.00067142  0.00132057  0.6387  0.523015    
## Tau2_5_5    0.00361661  0.00161473  0.00045180  0.00678142  2.2398  0.025106 *  
## Tau2_6_6    0.00576798  0.00241771  0.00102936  0.01050661  2.3857  0.017046 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Q statistic on the homogeneity of effect sizes: 580.9583
## Degrees of freedom of the Q statistic: 108
## P value of the Q statistic: 0
## 
## Heterogeneity indices (based on the estimated Tau2):
##                              Estimate
## Intercept1: I2 (Q statistic)   0.7859
## Intercept2: I2 (Q statistic)   0.8876
## Intercept3: I2 (Q statistic)   0.3641
## Intercept4: I2 (Q statistic)   0.1274
## Intercept5: I2 (Q statistic)   0.7614
## Intercept6: I2 (Q statistic)   0.7548
## 
## Number of studies (or clusters): 19
## Number of observed statistics: 114
## Number of estimated parameters: 12
## Degrees of freedom: 102
## -2 log likelihood: -240.0904 
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values may indicate problems.)
```

### Fitting the Stage 2 model in both subgroups

```r
## Stage 2 analysis per subgroup (random-effect analysis)
stage2_g1.fit <- tssem2(stage1_g1.fit, Amatrix=RAM1$A, Smatrix=RAM1$S)
stage2_g2.fit <- tssem2(stage1_g2.fit, Amatrix=RAM1$A, Smatrix=RAM1$S)

summary(stage2_g1.fit)
```

```
## 
## Call:
## wls(Cov = pooledS, aCov = aCov, n = tssem1.obj$total.n, Amatrix = Amatrix, 
##     Smatrix = Smatrix, Fmatrix = Fmatrix, diag.constraints = diag.constraints, 
##     cor.analysis = cor.analysis, intervals.type = intervals.type, 
##     mx.algebras = mx.algebras, model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##             Estimate   Std.Error      lbound      ubound z value  Pr(>|z|)    
## s2s       0.63876944  0.03971217  0.56093503  0.71660386 16.0850 < 2.2e-16 ***
## w2s       0.07329761  0.04729102 -0.01939108  0.16598629  1.5499 0.1211591    
## s2w       0.09167722  0.04642779  0.00068041  0.18267402  1.9746 0.0483114 *  
## w2w       0.61623243  0.03020864  0.55702457  0.67544028 20.3992 < 2.2e-16 ***
## w1WITHs1  0.46330813  0.03480189  0.39509768  0.53151857 13.3127 < 2.2e-16 ***
## w2WITHs2  0.15691514  0.04756351  0.06369238  0.25013790  3.2991 0.0009701 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                             Value
## Sample size                                4863.0
## Chi-square of target model                    0.0
## DF of target model                            0.0
## p value of target model                       0.0
## Number of constraints imposed on "Smatrix"    0.0
## DF manually adjusted                          0.0
## Chi-square of independence model           2025.5
## DF of independence model                      6.0
## RMSEA                                         0.0
## RMSEA lower 95% CI                            0.0
## RMSEA upper 95% CI                            0.0
## SRMR                                          0.0
## TLI                                          -Inf
## CFI                                           1.0
## AIC                                           0.0
## BIC                                           0.0
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
```

```r
summary(stage2_g2.fit)
```

```
## 
## Call:
## wls(Cov = pooledS, aCov = aCov, n = tssem1.obj$total.n, Amatrix = Amatrix, 
##     Smatrix = Smatrix, Fmatrix = Fmatrix, diag.constraints = diag.constraints, 
##     cor.analysis = cor.analysis, intervals.type = intervals.type, 
##     mx.algebras = mx.algebras, model.name = model.name, suppressWarnings = suppressWarnings, 
##     silent = silent, run = run)
## 
## 95% confidence intervals: z statistic approximation
## Coefficients:
##          Estimate Std.Error   lbound   ubound z value  Pr(>|z|)    
## s2s      0.550458  0.018924 0.513368 0.587547 29.0885 < 2.2e-16 ***
## w2s      0.082166  0.019219 0.044498 0.119834  4.2753 1.909e-05 ***
## s2w      0.074617  0.018300 0.038749 0.110485  4.0774 4.554e-05 ***
## w2w      0.546394  0.026741 0.493983 0.598805 20.4330 < 2.2e-16 ***
## w1WITHs1 0.325734  0.022863 0.280923 0.370544 14.2472 < 2.2e-16 ***
## w2WITHs2 0.177559  0.021402 0.135612 0.219506  8.2964 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Goodness-of-fit indices:
##                                             Value
## Sample size                                8043.0
## Chi-square of target model                    0.0
## DF of target model                            0.0
## p value of target model                       0.0
## Number of constraints imposed on "Smatrix"    0.0
## DF manually adjusted                          0.0
## Chi-square of independence model           2241.6
## DF of independence model                      6.0
## RMSEA                                         0.0
## RMSEA lower 95% CI                            0.0
## RMSEA upper 95% CI                            0.0
## SRMR                                          0.0
## TLI                                          -Inf
## CFI                                           1.0
## AIC                                           0.0
## BIC                                           0.0
## OpenMx status1: 0 ("0" or "1": The optimization is considered fine.
## Other values indicate problems.)
```

### Testing the equality of regression coefficients
* We create and fit a model with equal direct effects (we use the same matrix A for both groups), but different variances and covariances, so we create an S matrix with different labels for group 2.


```r
## Proposed model g2
model2 <- 'W2 ~ w2w*W1 + s2w*S1
           S2 ~ w2s*W1 + s2s*S1
           W1 ~~ g2w1WITHs1*S1
           W2 ~~ g2w2WITHs2*S2
           W1 ~~ 1*W1
           S1 ~~ 1*S1
           W2 ~~ g2Errw2*W2
           S2 ~~ g2Errs2*S2'
     
RAM2 <- lavaan2RAM(model2, obs.variables=c("W1", "S1", "W2", "S2"))

# Create the models for the two groups, make sure to set the argument run=FALSE
stage2_g1 <- tssem2(stage1_g1.fit, Amatrix=RAM1$A, Smatrix=RAM1$S, run=FALSE, model.name="g1")

stage2_g2 <- tssem2(stage1_g2.fit, Amatrix=RAM1$A, Smatrix=RAM2$S, run=FALSE, model.name="g2")

# Create the multigroup model
stage2_constrained <- mxModel(model="same_regression_coef", stage2_g1, stage2_g2,
                              mxFitFunctionMultigroup(c("g1", "g2")))

# Fit multigroup model with equality constraints
Stage2_constrained.fit <- mxRun(stage2_constrained, intervals=TRUE)
```

```
## Running same_regression_coef with 8 parameters
```

```r
# first make a list of the fitted models in the separate groups
submodels.fit <- list(stage2_g1.fit,stage2_g2.fit)

subgroup.summary(submodels.fit,Stage2_constrained.fit)
```

```
## # # # # # # # # # # # # # # # # # # #
##  Output for subgroup MASEM analysis 
## # # # # # # # # # # # # # # # # # # #
## 
##  Total sample size: 12906
## 
##  Parameter estimates of the constrained model
## 
## [1] "Set 'print.est=TRUE' to print the parameter estimates of the constrained model"
## 
##  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the free model:
## 
##           Statistic Free_m1
##                  df   0.000
##          Chi-square   0.000
##                   p   0.000
##               RMSEA     Inf
##  RMSEA lower 95% CI     Inf
##  RMSEA upper 95% CI     Inf
##                 CFI   1.000
##                 TLI    -Inf
##                 AIC  40.000
##                 BIC 189.309
##                SRMR   0.000
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Fit indices of the model with equality constraints:
## 
##           Statistic Constrained_m2
##                  df          4.000
##          Chi-square         13.247
##                   p          0.010
##               RMSEA          0.019
##  RMSEA lower 95% CI          0.006
##  RMSEA upper 95% CI          0.033
##                 CFI          0.998
##                 TLI          0.993
##                 AIC         45.247
##                 BIC        164.694
##                SRMR          0.025
## - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##  Chi-square difference between free and constrained model:
## 
##   Statistic Diff_m1_m2
##          df      4.000
##  Chi-square     13.247
##           p      0.010
## 
##  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```

# OSMASEM

## Data preparation

```r
library(metaSEM)
## Get the data
data <- Nohe15A1$data
n <- Nohe15A1$n
Lag <- Nohe15A1$Lag
  
## Calculate the sampling covariance matrix of the correlations
my.df <- Cor2DataFrame(data, n, acov = "weighted")

## Add standardized Lag as a moderator.
## Standardization of the moderator improves the convergence.
my.df$data <- data.frame(my.df$data, Lag=scale(Nohe15A1$Lag),
                         check.names=FALSE)
head(my.df$data)
```

```
##                                        S1_W1 W2_W1 S2_W1 W2_S1 S2_S1 S2_W2 C(S1_W1 S1_W1)
## Britt...Dawson..2005.                   0.29  0.58  0.22  0.24  0.57  0.27   0.0014224796
## Demerouti.et.al...2004.                 0.53  0.57  0.41  0.41  0.68  0.54   0.0020763953
## Ford..2010.                             0.35  0.75  0.32  0.26  0.74  0.30   0.0021207113
## Hammer.et.al...2005...female.subsample  0.32  0.57  0.22  0.30  0.43  0.30   0.0029726165
## Hammer.et.al...2005...male.subsample    0.19  0.54  0.17  0.21  0.60  0.30   0.0029726200
## Innstrand.et.al...2008.                 0.42  0.63  0.31  0.30  0.62  0.44   0.0003112273
##                                        C(W2_W1 S1_W1) C(S2_W1 S1_W1) C(W2_S1 S1_W1) C(S2_S1 S1_W1)
## Britt...Dawson..2005.                    2.033643e-04   0.0008791256   0.0008736619   2.047351e-04
## Demerouti.et.al...2004.                  2.968501e-04   0.0012832596   0.0012752852   2.988517e-04
## Ford..2010.                              3.031887e-04   0.0013106500   0.0013025055   3.052319e-04
## Hammer.et.al...2005...female.subsample   4.249794e-04   0.0018371444   0.0018257277   4.278421e-04
## Hammer.et.al...2005...male.subsample     4.249807e-04   0.0018371487   0.0018257323   4.278442e-04
## Innstrand.et.al...2008.                  4.449447e-05   0.0001923457   0.0001911504   4.479442e-05
##                                        C(S2_W2 S1_W1) C(W2_W1 W2_W1) C(S2_W1 W2_W1) C(W2_S1 W2_W1)
## Britt...Dawson..2005.                    0.0004890905   0.0007981113   3.750403e-04   3.671028e-04
## Demerouti.et.al...2004.                  0.0007139251   0.0011650033   5.474449e-04   5.358594e-04
## Ford..2010.                              0.0007291644   0.0011898680   5.591321e-04   5.472992e-04
## Hammer.et.al...2005...female.subsample   0.0010220704   0.0016678476   7.837370e-04   7.671501e-04
## Hammer.et.al...2005...male.subsample     0.0010220753   0.0016678482   7.837389e-04   7.671521e-04
## Innstrand.et.al...2008.                  0.0001070092   0.0001746203   8.205565e-05   8.031913e-05
##                                        C(S2_S1 W2_W1) C(S2_W2 W2_W1) C(S2_W1 S2_W1) C(W2_S1 S2_W1)
## Britt...Dawson..2005.                    1.042816e-04   2.035390e-04   0.0016496830   0.0005769115
## Demerouti.et.al...2004.                  1.522191e-04   2.971046e-04   0.0024080426   0.0008421168
## Ford..2010.                              1.554697e-04   3.034484e-04   0.0024594381   0.0008600938
## Hammer.et.al...2005...female.subsample   2.179207e-04   4.253427e-04   0.0034474106   0.0012055932
## Hammer.et.al...2005...male.subsample     2.179219e-04   4.253451e-04   0.0034474154   0.0012055989
## Innstrand.et.al...2008.                  2.281587e-05   4.453259e-05   0.0003609373   0.0001262236
##                                        C(S2_S1 S2_W1) C(S2_W2 S2_W1) C(W2_S1 W2_S1) C(S2_S1 W2_S1)
## Britt...Dawson..2005.                    3.592781e-04   0.0008607802   0.0016601418   3.727419e-04
## Demerouti.et.al...2004.                  5.244378e-04   0.0012564802   0.0024233103   5.440913e-04
## Ford..2010.                              5.356328e-04   0.0012832990   0.0024750317   5.557057e-04
## Hammer.et.al...2005...female.subsample   7.507965e-04   0.0017988054   0.0034692670   7.789321e-04
## Hammer.et.al...2005...male.subsample     7.507988e-04   0.0017988106   0.0034692733   7.789352e-04
## Innstrand.et.al...2008.                  7.860708e-05   0.0001883317   0.0003632258   8.155294e-05
##                                        C(S2_W2 W2_S1) C(S2_S1 S2_S1) C(S2_W2 S2_S1) C(S2_W2 S2_W2)
## Britt...Dawson..2005.                    0.0008739038   0.0007805640   1.951871e-04   0.0013981162
## Demerouti.et.al...2004.                  0.0012756371   0.0011393902   2.849141e-04   0.0020408307
## Ford..2010.                              0.0013028647   0.0011637077   2.909967e-04   0.0020843877
## Hammer.et.al...2005...female.subsample   0.0018262301   0.0016311776   4.078878e-04   0.0029217002
## Hammer.et.al...2005...male.subsample     0.0018262364   0.0016311785   4.078908e-04   0.0029217051
## Innstrand.et.al...2008.                  0.0001912031   0.0001707811   4.270533e-05   0.0003058965
##                                               Lag
## Britt...Dawson..2005.                  -0.6794521
## Demerouti.et.al...2004.                -0.7711151
## Ford..2010.                            -0.8016694
## Hammer.et.al...2005...female.subsample -0.1294740
## Hammer.et.al...2005...male.subsample   -0.1294740
## Innstrand.et.al...2008.                 0.6038301
```

```r
## Check the number of studies
pattern.na(Nohe15A1$data, show.na = FALSE)
```

```
##    W1 S1 W2 S2
## W1 32 32 32 32
## S1 32 32 32 32
## W2 32 32 32 32
## S2 32 32 32 32
```

```r
## Proposed model
model1 <- 'W2 ~ w2w*W1 + s2w*S1
           S2 ~ w2s*W1 + s2s*S1
           W1 ~~ w1WITHs1*S1
           W2 ~~ w2WITHs2*S2
           W1 ~~ 1*W1
           S1 ~~ 1*S1
           W2 ~~ Errw2*W2
           S2 ~~ Errs2*S2'

plot(model1, col="yellow")     
```

![](Nohe2015_files/figure-html/unnamed-chunk-11-1.png)<!-- -->

```r
## Convert the lavaan syntax into the RAM specification
RAM1 <- lavaan2RAM(model1, obs.variables=c("W1", "S1", "W2", "S2"))
RAM1
```

```
## $A
##    W1      S1      W2  S2 
## W1 "0"     "0"     "0" "0"
## S1 "0"     "0"     "0" "0"
## W2 "0*w2w" "0*s2w" "0" "0"
## S2 "0*w2s" "0*s2s" "0" "0"
## 
## $S
##    W1           S1           W2           S2          
## W1 "1"          "0*w1WITHs1" "0"          "0"         
## S1 "0*w1WITHs1" "1"          "0"          "0"         
## W2 "0"          "0"          "0*Errw2"    "0*w2WITHs2"
## S2 "0"          "0"          "0*w2WITHs2" "0*Errs2"   
## 
## $F
##    W1 S1 W2 S2
## W1  1  0  0  0
## S1  0  1  0  0
## W2  0  0  1  0
## S2  0  0  0  1
## 
## $M
##   W1 S1 W2 S2
## 1  0  0  0  0
```

## Model without any moderator

```r
## Create the model implied correlation structure with implicit diagonal constraints
M0 <- create.vechsR(A0=RAM1$A, S0=RAM1$S)

## Create the heterogeneity variance-covariance matrix
## RE.type= either "Diag" or "Symm"
## Transform= either "expLog" or "sqSD" for better estimation on variances
T0 <- create.Tau2(RAM=RAM1, RE.type="Diag", Transform="expLog", RE.startvalues=0.05)

mx.fit0 <- osmasem(model.name="No moderator", Mmatrix=M0, Tmatrix=T0, data=my.df)
```

```
## Running No moderator with 12 parameters
```

```r
summary(mx.fit0)
```

```
## Summary of No moderator 
##  
## free parameters:
##        name  matrix row col    Estimate  Std.Error A    z value     Pr(>|z|)
## 1       w2w      A0  W2  W1  0.57247128 0.02226456    25.712219 0.000000e+00
## 2       w2s      A0  S2  W1  0.08023682 0.02484213     3.229869 1.238471e-03
## 3       s2w      A0  W2  S1  0.08584125 0.02479589     3.461914 5.363481e-04
## 4       s2s      A0  S2  S1  0.58612399 0.02079000    28.192590 0.000000e+00
## 5  w1WITHs1      S0  S1  W1  0.38045215 0.02256155    16.862851 0.000000e+00
## 6  w2WITHs2      S0  S2  W2  0.16888458 0.02523191     6.693293 2.182032e-11
## 7    Tau1_1 vecTau1   1   1 -2.15335898 0.14358421   -14.997185 0.000000e+00
## 8    Tau1_2 vecTau1   2   1 -2.36882261 0.14419314   -16.428123 0.000000e+00
## 9    Tau1_3 vecTau1   3   1 -2.47296554 0.15796632   -15.655017 0.000000e+00
## 10   Tau1_4 vecTau1   4   1 -2.47676212 0.15669551   -15.806210 0.000000e+00
## 11   Tau1_5 vecTau1   5   1 -2.46245684 0.14519713   -16.959405 0.000000e+00
## 12   Tau1_6 vecTau1   6   1 -2.19983819 0.14187316   -15.505668 0.000000e+00
## 
## Model Statistics: 
##                |  Parameters  |  Degrees of Freedom  |  Fit (-2lnL units)
##        Model:             12                    180             -300.1701
##    Saturated:             27                    165                    NA
## Independence:             12                    180                    NA
## Number of observations/statistics: 12906/192
## 
## Information Criteria: 
##       |  df Penalty  |  Parameters Penalty  |  Sample-Size Adjusted
## AIC:      -660.1701              -276.1701                -276.1459
## BIC:     -2003.9507              -186.5847                -224.7195
## To get additional fit indices, see help(mxRefModels)
## timestamp: 2018-11-02 17:05:16 
## Wall clock time: 0.2920587 secs 
## optimizer:  SLSQP 
## OpenMx version number: 2.11.5 
## Need help?  See help(mxSummary)
```

```r
## The variance-covariance matrix in mx.fit0 is based on the untransformed matrix
## Extract the heterogeneity variance-covariance matrix
VarCorr(mx.fit0)
```

```
##            Tau2_1      Tau2_2      Tau2_3      Tau2_4      Tau2_5     Tau2_6
## Tau2_1 0.01347771 0.000000000 0.000000000 0.000000000 0.000000000 0.00000000
## Tau2_2 0.00000000 0.008759248 0.000000000 0.000000000 0.000000000 0.00000000
## Tau2_3 0.00000000 0.000000000 0.007112289 0.000000000 0.000000000 0.00000000
## Tau2_4 0.00000000 0.000000000 0.000000000 0.007058489 0.000000000 0.00000000
## Tau2_5 0.00000000 0.000000000 0.000000000 0.000000000 0.007263353 0.00000000
## Tau2_6 0.00000000 0.000000000 0.000000000 0.000000000 0.000000000 0.01228131
```

## Model with `Lag` as a moderator on the A matrix

```r
Ax <- matrix(c(0,0,0,0,
               0,0,0,0,
               "0*data.Lag","0*data.Lag",0,0,
               "0*data.Lag","0*data.Lag",0,0),
             nrow=4, ncol=4, byrow=TRUE)
Ax              
```

```
##      [,1]         [,2]         [,3] [,4]
## [1,] "0"          "0"          "0"  "0" 
## [2,] "0"          "0"          "0"  "0" 
## [3,] "0*data.Lag" "0*data.Lag" "0"  "0" 
## [4,] "0*data.Lag" "0*data.Lag" "0"  "0"
```

```r
## When there are more than one moderators
## Ax <- list(A1, A2, A3)

## Create the model implied correlation structure with the standardized Lag as the moderator
M1 <- create.vechsR(A0=RAM1$A, S0=RAM1$S, Ax=Ax)

mx.fit1 <- osmasem(model.name="Ax as moderator", Mmatrix=M1, Tmatrix=T0, data=my.df)
summary(mx.fit1)
```

```
## Summary of Ax as moderator 
##  
## free parameters:
##        name  matrix row col     Estimate  Std.Error A     z value     Pr(>|z|)
## 1       w2w      A0  W2  W1  0.573039768 0.01839765    31.1474437 0.000000e+00
## 2       w2s      A0  S2  W1  0.079844952 0.02419488     3.3000762 9.665858e-04
## 3       s2w      A0  W2  S1  0.085391025 0.02393612     3.5674553 3.604649e-04
## 4       s2s      A0  S2  S1  0.586234254 0.01962561    29.8708871 0.000000e+00
## 5  w1WITHs1      S0  S1  W1  0.381183700 0.02282277    16.7019061 0.000000e+00
## 6  w2WITHs2      S0  S2  W2  0.166974813 0.02500438     6.6778216 2.425193e-11
## 7     w2w_1      A1  W2  W1 -0.062015593 0.01850573    -3.3511561 8.047492e-04
## 8     w2s_1      A1  S2  W1 -0.025933719 0.02096723    -1.2368689 2.161357e-01
## 9     s2w_1      A1  W2  S1 -0.002382815 0.02055897    -0.1159015 9.077306e-01
## 10    s2s_1      A1  S2  S1 -0.027809762 0.01974172    -1.4086800 1.589298e-01
## 11   Tau1_1 vecTau1   1   1 -2.138190804 0.14360104   -14.8898001 0.000000e+00
## 12   Tau1_2 vecTau1   2   1 -2.630518363 0.16155259   -16.2827371 0.000000e+00
## 13   Tau1_3 vecTau1   3   1 -2.524194223 0.16007543   -15.7687796 0.000000e+00
## 14   Tau1_4 vecTau1   4   1 -2.519908840 0.15983967   -15.7652283 0.000000e+00
## 15   Tau1_5 vecTau1   5   1 -2.537475604 0.14712277   -17.2473347 0.000000e+00
## 16   Tau1_6 vecTau1   6   1 -2.198863504 0.14144099   -15.5461541 0.000000e+00
## 
## Model Statistics: 
##                |  Parameters  |  Degrees of Freedom  |  Fit (-2lnL units)
##        Model:             16                    176             -323.6921
##    Saturated:             27                    165                    NA
## Independence:             12                    180                    NA
## Number of observations/statistics: 12906/192
## 
## Information Criteria: 
##       |  df Penalty  |  Parameters Penalty  |  Sample-Size Adjusted
## AIC:      -675.6921              -291.6921                -291.6499
## BIC:     -1989.6109              -172.2450                -223.0913
## To get additional fit indices, see help(mxRefModels)
## timestamp: 2018-11-02 17:05:17 
## Wall clock time: 0.5191925 secs 
## optimizer:  SLSQP 
## OpenMx version number: 2.11.5 
## Need help?  See help(mxSummary)
```

```r
## Extract the residual heterogeneity variance-covariance matrix
VarCorr(mx.fit1)
```

```
##            Tau2_1      Tau2_2      Tau2_3      Tau2_4      Tau2_5     Tau2_6
## Tau2_1 0.01389284 0.000000000 0.000000000 0.000000000 0.000000000 0.00000000
## Tau2_2 0.00000000 0.005189921 0.000000000 0.000000000 0.000000000 0.00000000
## Tau2_3 0.00000000 0.000000000 0.006419671 0.000000000 0.000000000 0.00000000
## Tau2_4 0.00000000 0.000000000 0.000000000 0.006474929 0.000000000 0.00000000
## Tau2_5 0.00000000 0.000000000 0.000000000 0.000000000 0.006251391 0.00000000
## Tau2_6 0.00000000 0.000000000 0.000000000 0.000000000 0.000000000 0.01230528
```

```r
## Calculate the R2
## Tau2.0: Heterogeneity variances without the predictors
## Tau2.1: Heterogeneity variances with the predictors
## R2: (Tau2.0-Tau2.1)/Tau2.0
osmasemR2(mx.fit1, mx.fit0)
```

```
## $Tau2.0
##    Tau2_1_1    Tau2_2_2    Tau2_3_3    Tau2_4_4    Tau2_5_5    Tau2_6_6 
## 0.013477711 0.008759248 0.007112289 0.007058489 0.007263353 0.012281314 
## 
## $Tau2.1
##    Tau2_1_1    Tau2_2_2    Tau2_3_3    Tau2_4_4    Tau2_5_5    Tau2_6_6 
## 0.013892841 0.005189921 0.006419671 0.006474929 0.006251391 0.012305278 
## 
## $R2
##   Tau2_1_1   Tau2_2_2   Tau2_3_3   Tau2_4_4   Tau2_5_5   Tau2_6_6 
## 0.00000000 0.40749236 0.09738337 0.08267499 0.13932432 0.00000000
```

```r
## Compare the models with and without the moderator
anova(mx.fit1, mx.fit0)
```

```
##              base   comparison ep  minus2LL  df       AIC   diffLL diffdf            p
## 1 Ax as moderator         <NA> 16 -323.6921 176 -675.6921       NA     NA           NA
## 2 Ax as moderator No moderator 12 -300.1701 180 -660.1701 23.52201      4 9.957406e-05
```

```r
## Get the estimated A0 and A1
A0 <- mxEval(A0, mx.fit1$mx.fit)
A0
```

```
##            W1         S1 W2 S2
## W1 0.00000000 0.00000000  0  0
## S1 0.00000000 0.00000000  0  0
## W2 0.57303977 0.08539103  0  0
## S2 0.07984495 0.58623425  0  0
```

```r
A1 <- mxEval(A1, mx.fit1$mx.fit)
A1
```

```
##             W1           S1 W2 S2
## W1  0.00000000  0.000000000  0  0
## S1  0.00000000  0.000000000  0  0
## W2 -0.06201559 -0.002382815  0  0
## S2 -0.02593372 -0.027809762  0  0
```

```r
## Compute the estimated A matrix at -1SD (-1) of the standardized Lag
A0 - A1
```

```
##           W1         S1 W2 S2
## W1 0.0000000 0.00000000  0  0
## S1 0.0000000 0.00000000  0  0
## W2 0.6350554 0.08777384  0  0
## S2 0.1057787 0.61404402  0  0
```

```r
## Compute the estimated A matrix at 0 (mean) of the standardized Lag
A0
```

```
##            W1         S1 W2 S2
## W1 0.00000000 0.00000000  0  0
## S1 0.00000000 0.00000000  0  0
## W2 0.57303977 0.08539103  0  0
## S2 0.07984495 0.58623425  0  0
```

```r
## Compute the estimated A matrix at +1SD (+1) of the standardized Lag
A0 + A1
```

```
##            W1         S1 W2 S2
## W1 0.00000000 0.00000000  0  0
## S1 0.00000000 0.00000000  0  0
## W2 0.51102417 0.08300821  0  0
## S2 0.05391123 0.55842449  0  0
```


```r
sessionInfo()
```

```
## R version 3.5.1 (2018-07-02)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 18.04.1 LTS
## 
## Matrix products: default
## BLAS: /opt/microsoft/ropen/3.5.1/lib64/R/lib/libRblas.so
## LAPACK: /opt/microsoft/ropen/3.5.1/lib64/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8       
##  [4] LC_COLLATE=en_US.UTF-8     LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                  LC_ADDRESS=C              
## [10] LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] metaSEM_1.2.0        OpenMx_2.11.5        RevoUtils_11.0.1     RevoUtilsMath_11.0.0
## 
## loaded via a namespace (and not attached):
##   [1] nlme_3.1-137         RColorBrewer_1.1-2   rprojroot_1.3-2      mi_1.0              
##   [5] tools_3.5.1          backports_1.1.2      R6_2.3.0             rpart_4.1-13        
##   [9] d3Network_0.5.2.1    Hmisc_4.1-1          lazyeval_0.2.1       colorspace_1.3-2    
##  [13] nnet_7.3-12          tidyselect_0.2.5     gridExtra_2.3        mnormt_1.5-5        
##  [17] compiler_3.5.1       qgraph_1.5           fdrtool_1.2.15       htmlTable_1.12      
##  [21] network_1.13.0.1     scales_1.0.0         checkmate_1.8.5      mvtnorm_1.0-8       
##  [25] psych_1.8.10         pbapply_1.3-4        sem_3.1-9            stringr_1.3.1       
##  [29] digest_0.6.18        pbivnorm_0.6.0       foreign_0.8-71       minqa_1.2.4         
##  [33] rmarkdown_1.10       base64enc_0.1-3      jpeg_0.1-8           pkgconfig_2.0.2     
##  [37] htmltools_0.3.6      lme4_1.1-18-1        lisrelToR_0.1.4      htmlwidgets_1.3     
##  [41] rlang_0.3.0.1        rstudioapi_0.8       huge_1.2.7           bindr_0.1.1         
##  [45] gtools_3.8.1         statnet.common_4.1.4 acepack_1.4.1        dplyr_0.7.7         
##  [49] magrittr_1.5         Formula_1.2-3        Matrix_1.2-14        Rcpp_0.12.19        
##  [53] munsell_0.5.0        abind_1.4-5          rockchalk_1.8.117    whisker_0.3-2       
##  [57] stringi_1.2.4        yaml_2.2.0           carData_3.0-2        MASS_7.3-50         
##  [61] plyr_1.8.4           matrixcalc_1.0-3     lavaan_0.6-3         grid_3.5.1          
##  [65] parallel_3.5.1       crayon_1.3.4         lattice_0.20-35      semPlot_1.1         
##  [69] splines_3.5.1        sna_2.4              knitr_1.20           pillar_1.3.0        
##  [73] igraph_1.2.2         rjson_0.2.20         boot_1.3-20          corpcor_1.6.9       
##  [77] BDgraph_2.52         reshape2_1.4.3       stats4_3.5.1         XML_3.98-1.16       
##  [81] glue_1.3.0           evaluate_0.12        latticeExtra_0.6-28  data.table_1.11.8   
##  [85] png_0.1-7            nloptr_1.2.1         gtable_0.2.0         purrr_0.2.5         
##  [89] assertthat_0.2.0     ggplot2_3.1.0        semTools_0.5-1       coda_0.19-2         
##  [93] survival_2.43-1      glasso_1.10          tibble_1.4.2         arm_1.10-1          
##  [97] ggm_2.3              ellipse_0.4.1        bindrcpp_0.2.2       cluster_2.0.7-1
```
